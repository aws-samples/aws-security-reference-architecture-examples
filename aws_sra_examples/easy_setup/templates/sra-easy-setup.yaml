########################################################################
# Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.
# SPDX-License-Identifier: MIT-0
########################################################################
AWSTemplateFormatVersion: "2010-09-09"
Description:
  Creates the SRA CodeBuild Project that deploys the staging, common prerequisites, and other components of the SRA. - 'easy_setup' solution in the
  repo, https://github.com/aws-samples/aws-security-reference-architecture-examples (sra-1ssgnse7p)
Metadata:
  SRA:
    Version: 1.0
    Order: 1
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: General Properties
        Parameters:
          - pSRASolutionTagKey
          - pSRASolutionName
          # - pAWSControlTowerExecutionRoleName
          # - pOrganizationId
          - pSRAStagingS3BucketNamePrefix
          - pSRAStagingS3BucketStackName
          - pRepoURL
          - pRepoBranch
      - Label:
          default: Landing Zone
        Parameters:
          - pControlTower
          - pGovernedRegions
          - pSecurityAccountId
          - pLogArchiveAccountId
      - Label:
          default: CodeBuild Properties
        Parameters:
          - pCodeBuildProjectName
          - pCodeBuildRoleName
      - Label:
          default: AWS Code Build Project - Lambda Function Properties
        Parameters:
          - pCodeBuildProjectLambdaRoleName
          - pCodeBuildProjectLambdaFunctionName
      - Label:
          default: SRA Solutions to deploy (more settings for each are found below)
        Parameters:
          - pDeployAccountAlternateContactsSolution
          - pDeployCloudTrailSolution
          - pDeployConfigSolution
          - pDeployConfigManagementSolution
          - pDeployConfigConformancePackSolution
          - pDeployEC2DefaultEBSEncryptionSolution
          - pDeployDetectiveSolution
          - pDeployFirewallManagerSolution
          - pDeployGuardDutySolution
          - pDeployIAMAccessAnalyzerSolution
          - pDeployIAMPasswordPolicySolution
          - pDeployMacieSolution
          - pDeployS3BlockAccountPublicAccessSolution
          - pDeploySecurityHubSolution
          - pDeployShieldSolution
          - pDeployInspectorSolution
          - pDeployPatchMgrSolution
      - Label:
          default: Account Alternate Contacts Solution (optional parameters are required if solution is deployed)
        Parameters:
          - pExcludeAlternateContactAccountTags
          - pBillingContactAction
          - pOperationsContactAction
          - pSecurityContactAction
          - pBillingName
          - pBillingTitle
          - pBillingEmail
          - pBillingPhone
          - pOperationsName
          - pOperationsTitle
          - pOperationsEmail
          - pOperationsPhone
          - pSecurityName
          - pSecurityTitle
          - pSecurityEmail
          - pSecurityPhone
      - Label:
          default: AWS CloudTrail Solution
        Parameters:
          - pCloudTrailName
          - pEnableDataEventsOnly
          - pEnableLambdaDataEvents
          - pEnableS3DataEvents
          - pBucketNamePrefix
          - pCloudTrailLogGroupKmsKey
          - pCloudTrailLogGroupRetention
          - pCreateCloudTrailLogGroup
          - pOrganizationCloudTrailKeyAlias
      - Label:
          default: AWS Config Solution (This solution is incompatible with the AWS Control Tower environment)
        Parameters:
          - pCommonPrerequisitesRegionsOnly
          - pConfigEnabledRegions
          - pRecorderName
          - pAllSupported
          - pIncludeGlobalResourceTypes
          - pResourceTypes
          - pDeliveryChannelName
          - pConfigOrgDeliveryBucketPrefix
          - pConfigOrgDeliveryKeyAlias
          - pFrequency
          - pConfigTopicName
          - pSubscribeToConfigurationTopic
          - pConfigurationEmail
          - pConfigOrgSnsKeyAlias
          - pAggregatorName
          - pAggregatorRoleName
          - pRegisterDelegatedAdminAccount
      - Label:
          default: AWS Config Management Solution
        Parameters:
          - pAllSupported
          - pFrequency
          - pIncludeGlobalResourceTypes
          - pKmsKeyArn
          - pResourceTypes
      - Label:
          default: AWS Config Conformance Pack Solution
        Parameters:
          - pConformancePackName
          - pConformancePackTemplateName
          - pDeliveryS3KeyPrefix
          - pConformancePackExcludedAccounts
      - Label:
          default: Detective Solution
        Parameters:
          - pDatasourcePackages
          - pGuarddutyEnabledForMoreThan48Hours
      - Label:
          default: EC2 Default EBS Encryption Solution
        Parameters:
          - pExcludeEC2DefaultEBSEncryptionTags
      - Label:
          default: Firewall Manager Solution
        Parameters:
          - pEnableRemediation
          - pInternalNetCIDR
          - pCreateVpcForSG
          - pVPCCidrBlock
          - pVpcId
      - Label:
          default: GuardDuty Solution
        Parameters:
          - pDisableGuardDuty
          - pAutoEnableS3Logs
          - pAutoEnableKubernetesAuditLogs
          - pAutoEnableMalwareProtection
          - pEnableRdsLoginEvents
          - pEnableEksRuntimeMonitoring
          - pEnableEksAddonManagement
          - pEnableLambdaNetworkLogs
          - pGuardDutyFindingPublishingFrequency
          - pGuardDutyOrgDeliveryBucketPrefix
          - pGuardDutyOrgDeliveryKeyAlias
      - Label:
          default: IAM Access Analyzer Solution
        Parameters:
          - pAccessAnalyzerNamePrefix
          - pOrganizationAccessAnalyzerName
          - pAccessAnalyzerRegisterDelegatedAdminAccount
      - Label:
          default: IAM Password Policy Solution
        Parameters:
          - pAllowUsersToChangePassword
          - pHardExpiry
          - pMaxPasswordAge
          - pMinimumPasswordLength
          - pPasswordReusePrevention
          - pRequireLowercaseCharacters
          - pRequireNumbers
          - pRequireSymbols
          - pRequireUppercaseCharacters
      - Label:
          default: Macie Solution
        Parameters:
          - pDisableMacie
          - pMacieFindingPublishingFrequency
          - pMacieOrgDeliveryBucketPrefix
          - pMacieOrgDeliveryKeyAlias
      - Label:
          default: S3 Block Account Public Access Solution
        Parameters:
          - pExcludeS3BlockAccountPublicAccessTags
          - pEnableBlockPublicAcls
          - pEnableBlockPublicPolicy
          - pEnableIgnorePublicAcls
          - pEnableRestrictPublicBuckets
      - Label:
          default: Security Hub Solution
        Parameters:
          - pDisableSecurityHub
          - pEnableCISStandard
          - pCISStandardVersion
          - pEnablePCIStandard
          - pEnableSecurityBestPracticesStandard
          - pEnableNISTStandard
          - pNISTStandardVersion
          - pRegionLinkingMode

      - Label:
          default: Shield Advanced Solution
        Parameters:
          - pConfigureDRTTeamAccess
          - pResourcesToProtect
          - pShieldAccountsToProtect
          - pShieldDRTRoleName
          - pShieldAutoRenew
          - pShieldDRTLogBuckets
          - pShieldWarning
          - pProtectionGroup0AccountId
          - pProtectionGroup0Id
          - pProtectionGroup0Aggregation
          - pProtectionGroup0Pattern
          - pProtectionGroup0ResourceType
          - pProtectionGroup0Members
          - pProtectionGroup1AccountId
          - pProtectionGroup1Id
          - pProtectionGroup1Aggregation
          - pProtectionGroup1Pattern
          - pProtectionGroup1ResourceType
          - pProtectionGroup1Members
          - pProtectionGroup2AccountId
          - pProtectionGroup2Id
          - pProtectionGroup2Aggregation
          - pProtectionGroup2Pattern
          - pProtectionGroup2ResourceType
          - pProtectionGroup2Members
          - pProtectionGroup3AccountId
          - pProtectionGroup3Id
          - pProtectionGroup3Aggregation
          - pProtectionGroup3Pattern
          - pProtectionGroup3ResourceType
          - pProtectionGroup3Members
          - pProtectionGroup4AccountId
          - pProtectionGroup4Id
          - pProtectionGroup4Aggregation
          - pProtectionGroup4Pattern
          - pProtectionGroup4ResourceType
          - pProtectionGroup4Members
          - pShieldEnableProactiveEngagement
          - pShieldProactiveEngagementEmail
          - pShieldProactiveEngagementPhoneNumber
          - pShieldProactiveEngagementNotes

      - Label:
          default: Inspector Solution
        Parameters:
          - pScanComponents
          - pEcrRescanDuration

      - Label:
          default: Patch Manager Solution
        Parameters:
          - pPatchMgmtRoleName
          # Window 1
          - pPatchMgmtMaintWindow1Name
          - pPatchMgmtMaintWindow1Desc
          - pPatchMgmtMaintWindow1Schedule
          - pPatchMgmtMaintWindow1Duration
          - pPatchMgmtMaintWindow1Cutoff
          - pPatchMgmtMaintWindow1TZ
          - pPatchMgmtTask1Name
          - pPatchMgmtTask1Desc
          - pPatchMgmtTask1Operation
          - pPatchMgmtTask1RebootOption
          - pPatchMgmtTask1RunCmd
          - pPatchMgmtTarget1Name
          - pPatchMgmtTarget1Desc
          - pPatchMgmtTarget1Value1
          - pPatchMgmtTarget1Value2
          # Window 2
          - pPatchMgmtMaintWindow2Name
          - pPatchMgmtMaintWindow2Desc
          - pPatchMgmtMaintWindow2Schedule
          - pPatchMgmtMaintWindow2Duration
          - pPatchMgmtMaintWindow2Cutoff
          - pPatchMgmtMaintWindow2TZ
          - pPatchMgmtTask2Name
          - pPatchMgmtTask2Desc
          - pPatchMgmtTask2Operation
          - pPatchMgmtTask2RebootOption
          - pPatchMgmtTask2RunCmd
          - pPatchMgmtTarget2Name
          - pPatchMgmtTarget2Desc
          - pPatchMgmtTarget2Value1
          # Window 3
          - pPatchMgmtMaintWindow3Name
          - pPatchMgmtMaintWindow3Desc
          - pPatchMgmtMaintWindow3Schedule
          - pPatchMgmtMaintWindow3Duration
          - pPatchMgmtMaintWindow3Cutoff
          - pPatchMgmtMaintWindow3TZ
          - pPatchMgmtTask3Name
          - pPatchMgmtTask3Desc
          - pPatchMgmtTask3Operation
          - pPatchMgmtTask3RebootOption
          - pPatchMgmtTask3RunCmd
          - pPatchMgmtTarget3Name
          - pPatchMgmtTarget3Desc
          - pPatchMgmtTarget3Value1

      - Label:
          default: Common Properties
        Parameters:
          - pSRAAlarmEmail
          - pCreateAWSControlTowerExecutionRole
      - Label:
          default: General Lambda Function and EventBridge Properties
        Parameters:
          - pComplianceFrequency
          - pCreateLambdaLogGroup
          - pLambdaLogGroupRetention
          - pLambdaLogGroupKmsKey
          - pLambdaLogLevel

    ParameterLabels:
      pControlTower:
        default: AWS Control Tower landing zone deployed/in-use
      pGovernedRegions:
        default: AWS regions (comma separated) if not using AWS Control Tower (leave set to ct-regions for AWS Control Tower environments)
      pSecurityAccountId:
        default: Security Tooling Account ID
      pLogArchiveAccountId:
        default: Log Archive Account ID
      pRepoURL:
        default: The AWS SRA public code repository HTTPS URL
      pRepoBranch:
        default: The AWS SRA public code repository branch name
      pSRASolutionName:
        default: SRA Solution Name
      pCodeBuildProjectName:
        default: SRA CodeBuild Project Name
      pCodeBuildRoleName:
        default: SRA CodeBuild Role Name
      pCodeBuildProjectLambdaRoleName:
        default: SRA CodeBuild Project Lambda Role Name
      pCodeBuildProjectLambdaFunctionName:
        default: SRA CodeBuild Project Lambda Function Name
      pSRAStagingS3BucketNamePrefix:
        default: SRA Staging S3 Bucket Name Prefix
      pSRAStagingS3BucketStackName:
        default: SRA Staging S3 Bucket Stack Name

      pScanComponents:
        default: Comma separated list of scan components (EC2, ECR, LAMBDA, LAMBDA_CODE)
      pEcrRescanDuration:
        default: ECR Rescan Duration
      pDeployInspectorSolution:
        default: Deploy the Inspector Solution

      pAccessAnalyzerNamePrefix:
        default: Access Analyzer Name Prefix
      pAccessAnalyzerRegisterDelegatedAdminAccount:
        default: Access Analyzer Register Delegated Admin Account
      pAllowUsersToChangePassword:
        default: Allow Users to Change Password
      pAllSupported:
        default: All Supported
      pAutoEnableS3Logs:
        default: Auto Enable S3 Logs
      pAutoEnableKubernetesAuditLogs:
        default: Auto Enable Kubernetes Audit Logs
      pAutoEnableMalwareProtection:
        default: Auto Enable Malware Protection
      pEnableRdsLoginEvents:
        default: Auto enable RDS Login Events
      pEnableEksRuntimeMonitoring:
        default: Auto enable EKS Runtime Monitoring
      pEnableEksAddonManagement:
        default: Auto enable EKS Add-on Management
      pEnableLambdaNetworkLogs:
        default: Auto enable Lambda Network Logs
      pBillingContactAction:
        default: Billing Alternate Contact Action
      pBillingEmail:
        default: (Optional) Billing Email Address
      pBillingName:
        default: (Optional) Billing Full Name
      pBillingPhone:
        default: (Optional) Billing Phone Number
      pBillingTitle:
        default: (Optional) Billing Title
      pBucketNamePrefix:
        default: S3 Log Bucket Name Prefix
      pCISStandardVersion:
        default: CIS Standard Version
      pCloudTrailLogGroupKmsKey:
        default: (Optional) CloudTrail CloudWatch Logs KMS Key
      pCloudTrailLogGroupRetention:
        default: CloudTrail Log Group Retention
      pCloudTrailName:
        default: CloudTrail Name
      pComplianceFrequency:
        default: Frequency to Check for Organizational Compliance
      pConformancePackExcludedAccounts:
        default: (Optional) Account IDs to Exclude From the Conformance Pack
      pConformancePackName:
        default: Conformance Pack Name
      pConformancePackTemplateName:
        default: Conformance Pack Template Name
      pCreateCloudTrailLogGroup:
        default: Create CloudTrail CloudWatch Log Group
      pCreateLambdaLogGroup:
        default: Create Lambda Log Group
      pCreateVpcForSG:
        default: Create VPC For Security Group
      pDatasourcePackages:
        default: (Optional) Datasource packages to start
      pDeliveryS3KeyPrefix:
        default: (Optional) Delivery S3 Key Prefix
      pDeployAccountAlternateContactsSolution:
        default: Deploy the Account Alternate Contacts Solution
      pDeployCloudTrailSolution:
        default: Deploy the CloudTrail Solution
      pDeployConfigConformancePackSolution:
        default: Deploy the AWS Config Conformance Pack Solution
      pDeployConfigSolution:
        default: Deploy the AWS Config Solution (This solution is incompatible with the AWS Control Tower environment)
      pDeployConfigManagementSolution:
        default: Deploy the AWS Config Management Solution
      pDeployEC2DefaultEBSEncryptionSolution:
        default: Deploy the EC2 Default EBS Encryption Solution
      pDeployDetectiveSolution:
        default: Deploy the Detective Solution
      pDeployFirewallManagerSolution:
        default: Deploy the Firewall Manager Solution
      pDeployGuardDutySolution:
        default: Deploy the GuardDuty Solution
      pDeployIAMAccessAnalyzerSolution:
        default: Deploy the IAM Access Analyzer Solution
      pDeployIAMPasswordPolicySolution:
        default: Deploy the IAM Password Policy Solution
      pDeployMacieSolution:
        default: Deploy the Macie Solution
      pDeployS3BlockAccountPublicAccessSolution:
        default: Deploy the S3 Block Account Public Access Solution
      pDeploySecurityHubSolution:
        default: Deploy the Security Hub Solution
      pDisableGuardDuty:
        default: Disable GuardDuty
      pDisableMacie:
        default: Disable Macie
      pDisableSecurityHub:
        default: Disable Security Hub
      pEnableBlockPublicAcls:
        default: S3 Enable Block Public ACLs
      pEnableBlockPublicPolicy:
        default: S3 Enable Block Public Policy
      pEnableCISStandard:
        default: Enable CIS Standard
      pEnableDataEventsOnly:
        default: Enable Data Events Only
      pEnableIgnorePublicAcls:
        default: S3 Enable Ignore Public ACLs
      pEnableLambdaDataEvents:
        default: Enable Lambda Data Events
      pEnablePCIStandard:
        default: Enable PCI Standard
      pEnableRemediation:
        default: Enable Remediation
      pEnableRestrictPublicBuckets:
        default: S3 Enable Restrict Public Buckets
      pEnableS3DataEvents:
        default: Enable S3 Data Events
      pEnableSecurityBestPracticesStandard:
        default: Enable AWS Foundational Security Best Practices Standard
      pExcludeAlternateContactAccountTags:
        default: (Optional) Exclude Alternate Contact Account Tags
      pExcludeEC2DefaultEBSEncryptionTags:
        default: (Optional) Exclude EC2 Default EBS Encryption Tags
      pExcludeS3BlockAccountPublicAccessTags:
        default: (Optional) Exclude S3 Block Account Public Access Tags
      pFrequency:
        default: Frequency
      pGuarddutyEnabledForMoreThan48Hours:
        default: Guardduty Enabled More Than 48 Hours
      pGuardDutyFindingPublishingFrequency:
        default: GuardDuty Finding Publishing Frequency
      pGuardDutyOrgDeliveryBucketPrefix:
        default: GuardDuty Delivery Bucket Prefix
      pGuardDutyOrgDeliveryKeyAlias:
        default: GuardDuty Delivery KMS Key Alias
      pHardExpiry:
        default: Hard Expiry
      pIncludeGlobalResourceTypes:
        default: Include Global Resource Types
      pInternalNetCIDR:
        default: Internal Network CIDR
      pKmsKeyArn:
        default: (Optional) KMS Key ARN
      pLambdaLogGroupKmsKey:
        default: (Optional) Lambda Log Group KMS Key
      pLambdaLogGroupRetention:
        default: Lambda Log Group Retention
      pLambdaLogLevel:
        default: Lambda Log Level
      pMacieFindingPublishingFrequency:
        default: Macie Finding Publishing Frequency
      pMacieOrgDeliveryBucketPrefix:
        default: Macie Delivery Bucket Prefix
      pMacieOrgDeliveryKeyAlias:
        default: Macie Delivery KMS Key Alias
      pMaxPasswordAge:
        default: Max Password Age
      pMinimumPasswordLength:
        default: Minimum Password Length
      pEnableNISTStandard:
        default: Enable NIST Standard
      pNISTStandardVersion:
        default: NIST Standard Version
      pOperationsContactAction:
        default: Operations Alternate Contact Action
      pOperationsEmail:
        default: Operations Email Address
      pOperationsName:
        default: Operations Full Name
      pOperationsPhone:
        default: Operations Phone Number
      pOperationsTitle:
        default: Operations Title
      pOrganizationAccessAnalyzerName:
        default: Organization Access Analyzer Name
      pOrganizationCloudTrailKeyAlias:
        default: Organization CloudTrail KMS Key Alias
      pPasswordReusePrevention:
        default: Password Reuse Prevention
      pRegionLinkingMode:
        default: Region Linking Mode
      pRequireLowercaseCharacters:
        default: Require Lowercase Characters
      pRequireNumbers:
        default: Require Numbers
      pRequireSymbols:
        default: Require Symbols
      pRequireUppercaseCharacters:
        default: Require Uppercase Characters
      pResourceTypes:
        default: (Optional) Resource Types
      pSRAAlarmEmail:
        default: (Optional) SRA Alarm Email
      pCreateAWSControlTowerExecutionRole:
        default: Create AWS Control Tower Execution Role
      pSecurityContactAction:
        default: Security Alternate Contact Action
      pSecurityEmail:
        default: Security Email Address
      pSecurityName:
        default: Security Full Name
      pSecurityPhone:
        default: Security Phone Number
      pSecurityTitle:
        default: Security Title
      pVPCCidrBlock:
        default: New VPC CIDR Block
      pVpcId:
        default: (Optional) Existing VPC ID

      pDeployShieldSolution:
        default: Deploy the Shield Advanced Solution
      pConfigureDRTTeamAccess:
        default: Configure DRT Team Access
      pResourcesToProtect:
        default: Resource To Protect
      pShieldAccountsToProtect:
        default: Shield Accounts To Protect
      pShieldDRTRoleName:
        default: Shield DRT Role Name
      pShieldAutoRenew:
        default: Shield Auto Renew
      pShieldDRTLogBuckets:
        default: Shield DRT Log Buckets
      pShieldWarning:
        default: Shield Warning
      pProtectionGroup0AccountId:
        default: Protection Group 0 Account Id
      pProtectionGroup0Id:
        default: Protection Group 0 Id
      pProtectionGroup0Aggregation:
        default: Protection Group 0 Aggregation
      pProtectionGroup0Pattern:
        default: Protection Group 0 Pattern
      pProtectionGroup0ResourceType:
        default: Protection Group 0 Resource Type
      pProtectionGroup0Members:
        default: Protection Group 0 Members
      pProtectionGroup1AccountId:
        default: Protection Group 1 Account Id
      pProtectionGroup1Id:
        default: Protection Group 1 Id
      pProtectionGroup1Aggregation:
        default: Protection Group 1 Aggregation
      pProtectionGroup1Pattern:
        default: Protection Group 1 Pattern
      pProtectionGroup1ResourceType:
        default: Protection Group 1 Resource Type
      pProtectionGroup1Members:
        default: Protection Group 1 Members
      pProtectionGroup2AccountId:
        default: Protection Group 2 Account Id
      pProtectionGroup2Id:
        default: Protection Group 2 Id
      pProtectionGroup2Aggregation:
        default: Protection Group 2 Aggregation
      pProtectionGroup2Pattern:
        default: Protection Group 2 Pattern
      pProtectionGroup2ResourceType:
        default: Protection Group 2 Resource Type
      pProtectionGroup2Members:
        default: Protection Group 2 Members
      pProtectionGroup3AccountId:
        default: Protection Group 3 Account Id
      pProtectionGroup3Id:
        default: Protection Group 3 Id
      pProtectionGroup3Aggregation:
        default: Protection Group 3 Aggregation
      pProtectionGroup3Pattern:
        default: Protection Group 3 Pattern
      pProtectionGroup3ResourceType:
        default: Protection Group 3 Resource Type
      pProtectionGroup3Members:
        default: Protection Group 3 Members
      pProtectionGroup4AccountId:
        default: Protection Group 4 Account Id
      pProtectionGroup4Id:
        default: Protection Group 4 Id
      pProtectionGroup4Aggregation:
        default: Protection Group 4 Aggregation
      pProtectionGroup4Pattern:
        default: Protection Group 4 Pattern
      pProtectionGroup4ResourceType:
        default: Protection Group 4 Resource Type
      pProtectionGroup4Members:
        default: Protection Group 4 Members
      pShieldEnableProactiveEngagement:
        default: Shield Enable Proactive Engagement
      pShieldProactiveEngagementEmail:
        default: Shield Proactive Engagement Email
      pShieldProactiveEngagementPhoneNumber:
        default: Shield Proactive Engagement PhoneNumber
      pShieldProactiveEngagementNotes:
        default: Shield Proactive Engagement Notes

      pDeployPatchMgrSolution:
        default: Deploy the Patch Manager Solution
      pPatchMgmtRoleName:
        default: Patch Management Role Name
      # Window 1
      pPatchMgmtMaintWindow1Name:
        default: Patch Management Maintenance Window 1 Name
      pPatchMgmtMaintWindow1Desc:
        default: Patch Management Maintenance Window 1 Description
      pPatchMgmtMaintWindow1Schedule:
        default: Patch Management Maintenance Window 1 Schedule
      pPatchMgmtMaintWindow1Duration:
        default: Patch Management Maintenance Window 1 Duration
      pPatchMgmtMaintWindow1Cutoff:
        default: Patch Management Maintenance Window 1 Cutoff
      pPatchMgmtMaintWindow1TZ:
        default: Patch Management Maintenance Window 1 Timezone
      pPatchMgmtTask1Name:
        default: Patch Management Task 1 Name
      pPatchMgmtTask1Desc:
        default: Patch Management Task 1 Description
      pPatchMgmtTask1Operation:
        default: Patch Management Task 1 Operation
      pPatchMgmtTask1RebootOption:
        default: Patch Management Task 1 Reboot Option
      pPatchMgmtTask1RunCmd:
        default: Patch Management Task 1 Run Command
      pPatchMgmtTarget1Name:
        default: Patch Management Target 1 Name
      pPatchMgmtTarget1Desc:
        default: Patch Management Target 1 Description
      pPatchMgmtTarget1Value1:
        default: Patch Management Target 1 Value 1
      pPatchMgmtTarget1Value2:
        default: Patch Management Target 1 Value 2
      # Window 2
      pPatchMgmtMaintWindow2Name:
        default: Patch Management Maintenance Window 2 Name
      pPatchMgmtMaintWindow2Desc:
        default: Patch Management Maintenance Window 2 Description
      pPatchMgmtMaintWindow2Schedule:
        default: Patch Management Maintenance Window 2 Schedule
      pPatchMgmtMaintWindow2Duration:
        default: Patch Management Maintenance Window 2 Duration
      pPatchMgmtMaintWindow2Cutoff:
        default: Patch Management Maintenance Window 2 Cutoff
      pPatchMgmtMaintWindow2TZ:
        default: Patch Management Maintenance Window 2 Timezone
      pPatchMgmtTask2Name:
        default: Patch Management Task 2 Name
      pPatchMgmtTask2Desc:
        default: Patch Management Task 2 Description
      pPatchMgmtTask2Operation:
        default: Patch Management Task 2 Operation
      pPatchMgmtTask2RebootOption:
        default: Patch Management Task 2 Reboot Option
      pPatchMgmtTask2RunCmd:
        default: Patch Management Task 2 Run Command
      pPatchMgmtTarget2Name:
        default: Patch Management Target 2 Name
      pPatchMgmtTarget2Desc:
        default: Patch Management Target 2 Description
      pPatchMgmtTarget2Value1:
        default: Patch Management Target 2 Value 1
      # Window 3
      pPatchMgmtMaintWindow3Name:
        default: Patch Management Maintenance Window 3 Name
      pPatchMgmtMaintWindow3Desc:
        default: Patch Management Maintenance Window 3 Description
      pPatchMgmtMaintWindow3Schedule:
        default: Patch Management Maintenance Window 3 Schedule
      pPatchMgmtMaintWindow3Duration:
        default: Patch Management Maintenance Window 3 Duration
      pPatchMgmtMaintWindow3Cutoff:
        default: Patch Management Maintenance Window 3 Cutoff
      pPatchMgmtMaintWindow3TZ:
        default: Patch Management Maintenance Window 3 Timezone
      pPatchMgmtTask3Name:
        default: Patch Management Task 3 Name
      pPatchMgmtTask3Desc:
        default: Patch Management Task 3 Description
      pPatchMgmtTask3Operation:
        default: Patch Management Task 3 Operation
      pPatchMgmtTask3RebootOption:
        default: Patch Management Task 3 Reboot Option
      pPatchMgmtTask3RunCmd:
        default: Patch Management Task 3 Run Command
      pPatchMgmtTarget3Name:
        default: Patch Management Target 3 Name
      pPatchMgmtTarget3Desc:
        default: Patch Management Target 3 Description
      pPatchMgmtTarget3Value1:
        default: Patch Management Target 3 Value 1

      pCommonPrerequisitesRegionsOnly:
        default: Common Prerequisites Regions Only
      pConfigEnabledRegions:
        default: (Optional) Enabled Regions
      pRecorderName:
        default: Recorder Name
      pDeliveryChannelName:
        default: Delivery Channel Name
      pConfigOrgDeliveryBucketPrefix:
        default: Config Delivery Bucket Prefix
      pConfigOrgDeliveryKeyAlias:
        default: Config Delivery KMS Key Alias
      pConfigTopicName:
        default: Config SNS Topic Name
      pSubscribeToConfigurationTopic:
        default: Subscribe to Configuration Topic
      pConfigurationEmail:
        default: Configuration Email
      pConfigOrgSnsKeyAlias:
        default: Config SNS KMS Key Alias
      pAggregatorName:
        default: Config Aggregator Name
      pAggregatorRoleName:
        default: Config Aggregator Role Name
      pRegisterDelegatedAdminAccount:
        default: Register Delegated Admin Account

Parameters:
  pRepoURL:
    Default: https://github.com/aws-samples/aws-security-reference-architecture-examples.git
    Description: SRA Code Library Repository URL
    Type: String
  pRepoBranch:
    Default: main
    Description: SRA Code Library Repository branch name
    Type: String
  pControlTower:
    AllowedValues: ["true", "false"]
    Default: "true"
    Description: Indicates whether AWS Control Tower is deployed and being used for this AWS environment.
    Type: String
  pGovernedRegions:
    AllowedPattern: '^(ct-regions)|((\b(?<!@)(af-south-1|ap-east-1|ap-northeast-1|ap-northeast-2|ap-northeast-3|ap-south-1|ap-south-2|ap-southeast-1|ap-southeast-2|ap-southeast-3|ap-southeast-4|ca-central-1|cn-north-1|cn-northwest-1|eu-central-1|eu-central-2|eu-north-1|eu-south-1|eu-south-2|eu-west-1|eu-west-2|eu-west-3|me-central-1|me-south-1|sa-east-1|us-east-1|us-east-2|us-gov-east-1|us-gov-west-1|us-west-1|us-west-2)\b,{0,1})*)$'
    ConstraintDescription:
      For AWS Control Tower, set to ct-regions (default).  If not using AWS Control Tower, specify comma separated list of regions (e.g.
      us-west-2,us-east-1,ap-south-1) in lower case.
    Default: ct-regions
    Description: AWS regions (comma separated) if not using AWS Control Tower (leave set to ct-regions for AWS Control Tower environments)
    Type: String
  pSecurityAccountId:
    AllowedPattern: '^\d{12}$'
    Default: 111111111111
    ConstraintDescription: Must be 12 digits.
    Description: AWS Account ID of the Security Tooling account (ignored for AWS Control Tower environments).
    Type: String
  pLogArchiveAccountId:
    AllowedPattern: '^\d{12}$'
    Default: 222222222222
    ConstraintDescription: Must be 12 digits.
    Description: AWS Account ID of the Log Archive account (ignored for AWS Control Tower environments).
    Type: String
  pSRASolutionName:
    AllowedValues: [sra-common-prerequisites]
    Default: sra-common-prerequisites
    Description: The SRA solution name. The default value is the folder name of the solution
    Type: String
  pSRASolutionTagKey:
    AllowedValues: [sra-solution]
    Default: sra-solution
    Description: The SRA solution tag key applied to all resources created by the solution that support tagging. The value is the pSRASolutionName.
    Type: String
  pCodeBuildProjectName:
    AllowedValues: [sra-codebuild-project]
    Default: sra-codebuild-project
    Description: SRA CodeBuild project name
    Type: String
  pCodeBuildRoleName:
    AllowedValues: [sra-codebuild-role]
    Default: sra-codebuild-role
    Description: SRA CodeBuild role name
    Type: String
  pCodeBuildProjectLambdaRoleName:
    AllowedPattern: '^[\w+=,.@-]{1,64}$'
    ConstraintDescription: Max 64 alphanumeric characters. Also special characters supported [+, =, ., @, -].
    Default: sra-codebuild-project-lambda-role
    Description: Lambda execution role for starting the code build project
    Type: String
  pCodeBuildProjectLambdaFunctionName:
    AllowedPattern: '^[\w-]{1,64}$'
    ConstraintDescription: Max 64 alphanumeric characters. Also special characters supported [_, -]
    Default: sra-codebuild-project-lambda
    Description: Lambda function name for starting the code build project
    Type: String
  pSRAStagingS3BucketNamePrefix:
    AllowedValues: [sra-staging]
    Default: sra-staging
    Description:
      SRA Staging S3 bucket name prefix for the SRA artifacts relevant to the solutions. (e.g., lambda zips, CloudFormation templates). The account
      and region are added to the prefix <bucket-name-prefix>-<account-id>-<region>. Example = sra-staging-123456789012-us-east-1.
    Type: String
  pSRAStagingS3BucketStackName:
    AllowedValues: [sra-common-prerequisites-staging-s3-bucket]
    Default: sra-common-prerequisites-staging-s3-bucket
    Description: SRA Common Prerequisite Staging S3 bucket stack name.  This stack will be created by the SRA CodeBuild Project.
    Type: String

  pScanComponents:
    AllowedValues: [EC2, ECR, LAMBDA, LAMBDA_CODE]
    Default: EC2, ECR, LAMBDA, LAMBDA_CODE
    Description: Lambda Function Logging Level
    Type: CommaDelimitedList
  pEcrRescanDuration:
    AllowedValues: [LIFETIME, DAYS_30, DAYS_180]
    Default: LIFETIME
    Description: ECR Rescan Duration
    Type: String
  pDeployInspectorSolution:
    AllowedValues: ["Yes", "No"]
    Default: "No"
    Description: Deploy the Inspector solution
    Type: String

  pAccessAnalyzerNamePrefix:
    Default: sra-account-access-analyzer
    Description: Access Analyzer Name Prefix. The Account ID will be appended to the name.
    Type: String
  pAccessAnalyzerRegisterDelegatedAdminAccount:
    AllowedValues: ["Yes", "No"]
    Default: "Yes"
    Description: Register a delegated administrator account using the Common Register Delegated Administrator solution.
    Type: String
  pAllowUsersToChangePassword:
    AllowedValues: ["true", "false"]
    Default: "true"
    Description: You can permit all IAM users in your account to use the IAM console to change their own passwords.
    Type: String
  pAllSupported:
    AllowedValues: ["true", "false"]
    Default: "true"
    Description: Indicates whether to record all supported resource types. If set to 'false', then the 'Resource Types' parameter must have a value.
    Type: String
  pAutoEnableS3Logs:
    AllowedValues: ["true", "false"]
    Default: "true"
    Description: Auto enable S3 logs
    Type: String
  pAutoEnableKubernetesAuditLogs:
    AllowedValues: ["true", "false"]
    Default: "true"
    Description: Auto enable Kubernetes Audit Logs
    Type: String
  pAutoEnableMalwareProtection:
    AllowedValues: ["true", "false"]
    Default: "true"
    Description: Auto enable Malware Protection
    Type: String
  pEnableRdsLoginEvents:
    AllowedValues: ["true", "false"]
    Default: "true"
    Description: Auto enable RDS Login Events
    Type: String
  pEnableEksRuntimeMonitoring:
    AllowedValues: ["true", "false"]
    Default: "true"
    Description: Auto enable EKS Runtime Monitoring
    Type: String
  pEnableEksAddonManagement:
    AllowedValues: ["true", "false"]
    Default: "true"
    Description: Auto enable EKS Add-on Management
    Type: String
  pEnableLambdaNetworkLogs:
    AllowedValues: ["true", "false"]
    Default: "true"
    Description: Auto enable Lambda Network Logs
    Type: String
  pBillingContactAction:
    AllowedValues: ["add", "delete", "ignore"]
    Default: add
    Description: Indicates whether to add, delete, or ignore the Billing alternate contact.
    Type: String
  pBillingEmail:
    AllowedPattern: '^$|^([a-zA-Z0-9_.+-]+@[a-zA-Z0-9-]+\.[a-zA-Z0-9-.]+)$'
    ConstraintDescription: Email Validation as per RFC2822 standards.
    Default: ""
    Description:
      (Optional) Email Address for Billing alternate contact. If 'Billing Alternate Contact Action' parameter is set to 'add', then this parameter
      becomes required.
    Type: String
  pBillingName:
    AllowedPattern: '^(?![&<>\\%|]).*$'
    ConstraintDescription: All characters allowed except '&<>\%|'
    Default: ""
    Description:
      (Optional) Full Name for Billing alternate contact. If 'Billing Alternate Contact Action' parameter is set to 'add', then this parameter becomes
      required.
    Type: String
  pBillingPhone:
    AllowedPattern: '^$|^[\s0-9()+-]+$'
    ConstraintDescription: Must be numbers, special characters [()+-], and/or whitespace
    Default: ""
    Description:
      (Optional) Phone Number for Billing alternate contact. If 'Billing Alternate Contact Action' parameter is set to 'add', then this parameter
      becomes required.
    Type: String
  pBillingTitle:
    AllowedPattern: '^(?![&<>\\%|]).*$'
    ConstraintDescription: All characters allowed except '&<>\%|'
    Default: ""
    Description:
      (Optional) Title for Billing alternate contact. If 'Billing Alternate Contact Action' parameter is set to 'add', then this parameter becomes
      required.
    Type: String
  pBucketNamePrefix:
    AllowedPattern: ^$|^[0-9a-zA-Z]+([0-9a-zA-Z-]*[0-9a-zA-Z])*$
    ConstraintDescription: S3 bucket name can include numbers, lowercase letters, uppercase letters, and hyphens (-). It cannot start or end with a hyphen (-).
    Default: sra-org-trail-logs
    Description: S3 bucket prefix. The account and region will get added to the end. e.g. bucket-prefix-123456789012-us-east-1
    Type: String
  pCISStandardVersion:
    AllowedValues: [1.2.0, 1.4.0]
    Default: 1.4.0
    Description: CIS Standard Version
    Type: String
  pCloudTrailLogGroupKmsKey:
    AllowedPattern: ^$|^arn:(aws[a-zA-Z-]*){1}:kms:[a-z0-9-]+:\d{12}:key\/[a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12}$
    ConstraintDescription: "Key ARN example:  arn:aws:kms:us-east-2:111122223333:key/1234abcd-12ab-34cd-56ef-1234567890ab"
    Default: ""
    Description:
      (Optional) KMS Key ARN to use for encrypting the CloudTrail log group data. If empty, encryption is enabled with CloudWatch Logs managing the
      server-side encryption keys.
    Type: String
  pCloudTrailLogGroupRetention:
    AllowedValues:
      [
        1,
        3,
        5,
        7,
        14,
        30,
        60,
        90,
        120,
        150,
        180,
        365,
        400,
        545,
        731,
        1827,
        3653,
      ]
    Default: 400
    Description: Specifies the number of days you want to retain log events
    Type: String
  pCloudTrailName:
    AllowedPattern: '^[A-Za-z0-9][a-zA-Z0-9-\-_.]{2,127}$'
    ConstraintDescription:
      Contain only ASCII letters (a-z, A-Z), numbers (0-9), periods (.), underscores (_), or dashes (-) Start with a letter or number, and end with a
      letter or number Be between 3 and 128 characters Have no adjacent periods, underscores or dashes. Names like my-_namespace and my--namespace are
      invalid. Not be in IP address format (for example, 192.168.5.4)
    Default: sra-org-trail
    Description: CloudTrail name
    Type: String
  pComplianceFrequency:
    ConstraintDescription: Compliance Frequency must be a number between 1 and 30, inclusive.
    Default: 7
    Description: Frequency (in days between 1 and 30, default is 7) to check organizational compliance
    MinValue: 1
    MaxValue: 30
    Type: Number
  pConformancePackExcludedAccounts:
    AllowedPattern: '^$|^(\d{12})$|^((\d{12},)*\d{12})$'
    ConstraintDescription: AWS Account IDs separated by commas. (e.g. 123456789012,234567890123)
    Default: ""
    Description:
      (Optional) Comma delimited list of account IDs to exclude from the Organization conformance pack. Accounts that do not have AWS Config enabled
      must be excluded.
    Type: String
  pConformancePackName:
    AllowedPattern: "^[a-zA-Z][-a-zA-Z0-9]*$"
    ConstraintDescription:
      Name can include numbers, lowercase letters, uppercase letters, and hyphens (-). It cannot start or end with a hyphen (-). Max length is 128
      characters.
    Default: sra-operational-best-practices-for-encryption-and-keys
    Description: The name you assign to an organization conformance pack
    Type: String
  pConformancePackTemplateName:
    Default: Operational-Best-Practices-for-Encryption-and-Keys.yaml
    Description: Conformance pack template file name within the aws_config_conformance_packs folder. e.g. my-conformance-pack.yaml
    Type: String
  pCreateCloudTrailLogGroup:
    AllowedValues: ["true", "false"]
    Default: "true"
    Description:
      Indicates whether a CloudWatch Log Group should be created for the CloudTrail, to allow for setting a Log Retention and/or KMS Key for
      encryption.
    Type: String
  pCreateLambdaLogGroup:
    AllowedValues: ["Yes", "No"]
    Default: "No"
    Description:
      Indicates whether a CloudWatch Log Group should be explicitly created for the Lambda function, to allow for setting a Log Retention and/or KMS
      Key for encryption.
    Type: String
  pCreateVpcForSG:
    AllowedValues: ["true", "false"]
    Default: "true"
    Description: Create a new VPC for the Firewall Manager Security Groups
    Type: String
  pDatasourcePackages:
    AllowedValues: [ASFF_SECURITYHUB_FINDING, EKS_AUDIT, ""]
    Default: ASFF_SECURITYHUB_FINDING, EKS_AUDIT
    Description: Optional datasources used to populate the behavior graph. Valid values are ASFF_SECURITYHUB_FINDING and EKS_AUDIT
    Type: CommaDelimitedList
  pDeliveryS3KeyPrefix:
    AllowedPattern: "^$|^[a-zA-Z][-a-zA-Z0-9]*$"
    ConstraintDescription: Delivery S3 prefix can include numbers, lowercase letters, uppercase letters, and hyphens (-). It cannot start or end with a hyphen (-).
    Default: ""
    Description: (Optional) The prefix for the Amazon S3 bucket.
    Type: String
  pDeployAccountAlternateContactsSolution:
    AllowedValues: ["Yes", "No"]
    Default: "No"
    Description: Deploy the Account Alternate Contacts solution
    Type: String
  pDeployCloudTrailSolution:
    AllowedValues: ["Yes", "No"]
    Default: "No"
    Description: Deploy the CloudTrail solution
    Type: String
  pDeployConfigConformancePackSolution:
    AllowedValues: ["Yes", "No"]
    Default: "No"
    Description: Deploy the AWS Config Conformance Pack solution
    Type: String
  pDeployConfigSolution:
    AllowedValues: ["Yes", "No"]
    Default: "No"
    Description: Deploy the AWS Config solution (This solution is incompatible with the AWS Control Tower environment)
    Type: String
  pDeployConfigManagementSolution:
    AllowedValues: ["Yes", "No", "Already Deployed"]
    Default: "No"
    Description: Deploy the AWS Config Management solution. Note, if solution was previously deployed, choose 'Already Deployed'.
    Type: String
  pDeployDetectiveSolution:
    AllowedValues: ["Yes", "No"]
    Default: "No"
    Description: Deploy the Detective solution
    Type: String
  pDeployEC2DefaultEBSEncryptionSolution:
    AllowedValues: ["Yes", "No"]
    Default: "No"
    Description: Deploy the EC2 Default EBS Encryption solution
    Type: String
  pDeployFirewallManagerSolution:
    AllowedValues: ["Yes", "No"]
    Default: "No"
    Description: Deploy the Firewall Manager solution
    Type: String
  pDeployGuardDutySolution:
    AllowedValues: ["Yes", "No"]
    Default: "No"
    Description: Deploy the GuardDuty solution
    Type: String
  pDeployIAMAccessAnalyzerSolution:
    AllowedValues: ["Yes", "No"]
    Default: "No"
    Description: Deploy the IAM Access Analyzer solution
    Type: String
  pDeployIAMPasswordPolicySolution:
    AllowedValues: ["Yes", "No"]
    Default: "No"
    Description: Deploy the IAM Password Policy solution
    Type: String
  pDeployMacieSolution:
    AllowedValues: ["Yes", "No"]
    Default: "No"
    Description: Deploy the Macie solution
    Type: String
  pDeployS3BlockAccountPublicAccessSolution:
    AllowedValues: ["Yes", "No"]
    Default: "No"
    Description: Deploy the S3 Block Account Public Access solution
    Type: String
  pDeploySecurityHubSolution:
    AllowedValues: ["Yes", "No"]
    Default: "No"
    Description: Deploy the Security Hub solution
    Type: String
  pDisableGuardDuty:
    AllowedValues: ["Yes", "No"]
    Default: "No"
    Description: Disable the GuardDuty solution in all accounts and regions before deleting the stack.
    Type: String
  pDisableMacie:
    AllowedValues: ["Yes", "No"]
    Default: "No"
    Description: Disable the Macie solution in all accounts and regions before deleting the stack.
    Type: String
  pDisableSecurityHub:
    AllowedValues: ["Yes", "No"]
    Default: "No"
    Description: Disable the Security Hub solution in all accounts and regions before deleting the stack.
    Type: String
  pEnableBlockPublicAcls:
    AllowedValues: ["true", "false"]
    Default: "true"
    Description: S3 Enable Block Public ACLs
    Type: String
  pEnableBlockPublicPolicy:
    AllowedValues: ["true", "false"]
    Default: "true"
    Description: S3 Enable Block Public Policy
    Type: String
  pEnableCISStandard:
    AllowedValues: ["true", "false"]
    Default: "false"
    Description: Indicates whether to enable the CIS AWS Foundations Benchmark Standard.
    Type: String
  pEnableDataEventsOnly:
    AllowedValues: ["true", "false"]
    Default: "true"
    Description: Only Enable Cloud Trail Data Events
    Type: String
  pEnableIgnorePublicAcls:
    AllowedValues: ["true", "false"]
    Default: "true"
    Description: S3 Enable Ignore Public ACLs
    Type: String
  pEnableLambdaDataEvents:
    AllowedValues: ["true", "false"]
    Default: "true"
    Description: Enable Cloud Trail Data Events for all Lambda functions
    Type: String
  pEnablePCIStandard:
    AllowedValues: ["true", "false"]
    Default: "false"
    Description: Indicates whether to enable the Payment Card Industry Data Security Standard (PCI DSS).
    Type: String
  pEnableRemediation:
    AllowedValues: [true, false]
    Default: false
    Description: Chose to enable auto-remediation on Security Groups that violate the rules in the template
    Type: String
  pEnableRestrictPublicBuckets:
    AllowedValues: ["true", "false"]
    Default: "true"
    Description: S3 Enable Restrict Public Buckets
    Type: String
  pEnableS3DataEvents:
    AllowedValues: ["true", "false"]
    Default: "true"
    Description: Enable Cloud Trail S3 Data Events for all buckets
    Type: String
  pEnableSecurityBestPracticesStandard:
    AllowedValues: ["true", "false"]
    Default: "true"
    Description: Indicates whether to enable the AWS Foundational Security Best Practices Standard.
    Type: String
  pExcludeAlternateContactAccountTags:
    AllowedPattern: "^$|.*"
    Default: ""
    Description:
      '(Optional) Resource Tags that denote an Account should be excluded from this solution in JSON format: [{"Key": "string", "Value": "string"},
      ... ]. For example, [{"Key": "exclude-alternate-contacts", "Value": "true"}].'
    Type: String
  pExcludeEC2DefaultEBSEncryptionTags:
    AllowedPattern: "^$|.*"
    Default: ""
    Description:
      '(Optional) Resource Tags that denote an Account should be excluded from this solution in JSON format: [{"Key": "string", "Value": "string"},
      ... ]. For example, [{"Key": "exclude-ec2-default-ebs-encryption", "Value": "true"}].'
    Type: String
  pExcludeS3BlockAccountPublicAccessTags:
    AllowedPattern: "^$|.*"
    Default: ""
    Description:
      '(Optional) Resource Tags that denote an Account should be excluded from this solution in JSON format: [{"Key": "string", "Value": "string"},
      ... ]. For example, [{"Key": "exclude-s3-block-account-public-access", "Value": "true"}].'
    Type: String
  pFrequency:
    AllowedValues: [1hour, 3hours, 6hours, 12hours, 24hours]
    Default: 1hour
    Description: The frequency with which AWS Config delivers configuration snapshots.
    Type: String
  pGuarddutyEnabledForMoreThan48Hours:
    AllowedValues: ["true", "false"]
    Default: "false"
    Description: Has Guardduty been enabled in the Organization for more than 48 hours?
    Type: String
  pGuardDutyFindingPublishingFrequency:
    AllowedValues: [FIFTEEN_MINUTES, ONE_HOUR, SIX_HOURS]
    Default: FIFTEEN_MINUTES
    Description: Finding publishing frequency
    Type: String
  pGuardDutyOrgDeliveryBucketPrefix:
    AllowedPattern: "^$|^[0-9a-zA-Z]+([0-9a-zA-Z-]*[0-9a-zA-Z])*$"
    ConstraintDescription: S3 bucket name can include numbers, lowercase letters, uppercase letters, and hyphens (-). It cannot start or end with a hyphen (-).
    Default: sra-guardduty-org-delivery
    Description: GuardDuty Delivery S3 bucket prefix. The account and region will get added to the end. e.g. sra-guardduty-delivery-123456789012-us-east-1
    Type: String
  pGuardDutyOrgDeliveryKeyAlias:
    Default: sra-guardduty-org-delivery-key
    Description: GuardDuty Delivery KMS Key Alias
    Type: String
  pHardExpiry:
    AllowedValues: ["true", "false"]
    Default: "false"
    Description: "You can prevent IAM users from choosing a new password after their current password has expired."
    Type: String
  pIncludeGlobalResourceTypes:
    AllowedValues: ["true", "false"]
    Default: "true"
    Description: Indicates whether AWS Config records all supported global resource types.
    Type: String
  pInternalNetCIDR:
    AllowedPattern: '^([0-9]{1,3}\.){3}[0-9]{1,3}(\/([0-9]|[1-2][0-9]|3[0-2]))?$'
    ConstraintDescription: CIDR block parameter must be in the form x.x.x.x/16-28
    Default: 192.168.1.0/24
    Description:
      The CIDR block for the Internal Network (include both VPCs and On-Prem if using VPN/DirectConnect) - This is used to detect rules that don't
      align with the IP Space. Use CIDR Format. Example 192.168.1.0/24
    Type: String
  pKmsKeyArn:
    AllowedPattern: '^$|^arn:(aws[a-zA-Z-]*)?:kms:[a-z0-9-]+:\d{12}:key\/[a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12}$'
    ConstraintDescription: Key ARN example - arn:aws:kms:us-east-2:111122223333:key/1234abcd-12ab-34cd-56ef-1234567890ab
    Default: ""
    Description:
      (Optional) KMS key ARN to use for encrypting the AWS Config configuration snapshots and history files when storing in the S3 bucket in the Log
      Archive account. If empty, snapshots and history files will be encrypted based on the Default Encryption setting of the S3 bucket.
    Type: String
  pLambdaLogGroupKmsKey:
    AllowedPattern: '^$|^arn:(aws[a-zA-Z-]*){1}:kms:[a-z0-9-]+:\d{12}:key\/[a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12}$'
    ConstraintDescription: "Key ARN example:  arn:aws:kms:us-east-2:111122223333:key/1234abcd-12ab-34cd-56ef-1234567890ab"
    Default: ""
    Description:
      (Optional) KMS Key ARN to use for encrypting the Lambda logs data. If empty, encryption is enabled with CloudWatch Logs managing the server-side
      encryption keys.
    Type: String
  pLambdaLogGroupRetention:
    AllowedValues:
      [
        1,
        3,
        5,
        7,
        14,
        30,
        60,
        90,
        120,
        150,
        180,
        365,
        400,
        545,
        731,
        1827,
        3653,
      ]
    Default: 14
    Description: Specifies the number of days you want to retain log events
    Type: String
  pLambdaLogLevel:
    AllowedValues: [INFO, ERROR, DEBUG]
    Default: INFO
    Description: Lambda Function Logging Level
    Type: String
  pMacieFindingPublishingFrequency:
    AllowedValues: [FIFTEEN_MINUTES, ONE_HOUR, SIX_HOURS]
    Default: FIFTEEN_MINUTES
    Description: Finding publishing frequency
    Type: String
  pMacieOrgDeliveryBucketPrefix:
    AllowedPattern: "^$|^[0-9a-zA-Z]+([0-9a-zA-Z-]*[0-9a-zA-Z])*$"
    ConstraintDescription: S3 bucket name can include numbers, lowercase letters, uppercase letters, and hyphens (-). It cannot start or end with a hyphen (-).
    Default: sra-macie-org-delivery
    Description: Macie Delivery S3 bucket prefix. The account and region will get added to the end. e.g. macie-delivery-123456789012-us-east-1
    Type: String
  pMacieOrgDeliveryKeyAlias:
    AllowedPattern: "^[a-zA-Z0-9/_-]+$"
    ConstraintDescription: The alias must be string of 1-256 characters. It can contain only alphanumeric characters, forward slashes (/), underscores (_), and dashes (-).
    Default: sra-macie-org-delivery-key
    Description: Macie Delivery KMS Key Alias
    Type: String
  pMaxPasswordAge:
    ConstraintDescription: Must be in the range [1-1095]
    Default: 90
    Description: You can set IAM user passwords to be valid for only the specified number of days.
    MaxValue: 1095
    MinValue: 1
    Type: Number
  pMinimumPasswordLength:
    ConstraintDescription: Must be in the range [6-128]
    Default: 14
    Description: You can specify the minimum number of characters allowed in an IAM user password.
    MaxValue: 128
    MinValue: 6
    Type: Number
  pEnableNISTStandard:
    AllowedValues: ["true", "false"]
    Default: "false"
    Description: Indicates whether to enable the National Institute of Standards and Technology (NIST) SP 800-53 Rev. 5.
    Type: String
  pNISTStandardVersion:
    AllowedValues: [5.0.0]
    Default: 5.0.0
    Description: NIST Standard Version
    Type: String
  pOperationsContactAction:
    AllowedValues: ["add", "delete", "ignore"]
    Default: add
    Description: Indicates whether to add, delete, or ignore the Operations alternate contact.
    Type: String
  pOperationsEmail:
    AllowedPattern: '^$|^([a-zA-Z0-9_.+-]+@[a-zA-Z0-9-]+\.[a-zA-Z0-9-.]+)$'
    ConstraintDescription: Email Validation as per RFC2822 standards.
    Default: ""
    Description:
      (Optional) Email Address for Operations alternate contact. If 'Operations Alternate Contact Action' parameter is set to 'add', then this
      parameter becomes required.
    Type: String
  pOperationsName:
    AllowedPattern: '^(?![&<>\\%|]).*$'
    ConstraintDescription: All characters allowed except '&<>\%|'
    Default: ""
    Description:
      (Optional) Full Name for Operations alternate contact. If 'Operations Alternate Contact Action' parameter is set to 'add', then this parameter
      becomes required.
    Type: String
  pOperationsPhone:
    AllowedPattern: '^$|^[\s0-9()+-]+$'
    ConstraintDescription: Must be numbers, special characters [()+-], and/or whitespace
    Default: ""
    Description:
      (Optional) Phone Number for Operations alternate contact. If 'Operations Alternate Contact Action' parameter is set to 'add', then this
      parameter becomes required.
    Type: String
  pOperationsTitle:
    AllowedPattern: '^(?![&<>\\%|]).*$'
    ConstraintDescription: All characters allowed except '&<>\%|'
    Default: ""
    Description:
      (Optional) Title for Operations alternate contact. If 'Operations Alternate Contact Action' parameter is set to 'add', then this parameter
      becomes required.
    Type: String
  pOrganizationAccessAnalyzerName:
    Default: sra-organization-access-analyzer
    Description: Organization Access Analyzer Name
    Type: String
  pOrganizationCloudTrailKeyAlias:
    Default: sra-cloudtrail-org-key
    Description: Organization CloudTrail KMS Key Alias
    Type: String
  pPasswordReusePrevention:
    ConstraintDescription: Must be in the range [1-24]
    Default: 24
    Description: You can prevent IAM users from reusing a specified number of previous passwords.
    MaxValue: 24
    MinValue: 1
    Type: Number
  pRegionLinkingMode:
    AllowedValues: [SPECIFIED_REGIONS, ALL_REGIONS]
    Default: SPECIFIED_REGIONS
    Description:
      Indicates whether to aggregate findings from all of the available Regions in the current partition. Also determines whether to automatically
      aggregate findings from new Regions as Security Hub supports them and you opt into them.
    Type: String
  pRequireLowercaseCharacters:
    AllowedValues: ["true", "false"]
    Default: "true"
    Description: You can require that IAM user passwords contain at least one lowercase character from the ISO basic Latin alphabet (a to z).
    Type: String
  pRequireNumbers:
    AllowedValues: ["true", "false"]
    Default: "true"
    Description: You can require that IAM user passwords contain at least one numeric character (0 to 9).
    Type: String
  pRequireSymbols:
    AllowedValues: ["true", "false"]
    Default: "true"
    Description:
      "You can require that IAM user passwords contain at least one of the following non-alphanumeric characters: ! @ # $ % ^ & * ( ) _ + - = [ ] {} |
      '"
    Type: String
  pRequireUppercaseCharacters:
    AllowedValues: ["true", "false"]
    Default: "true"
    Description: You can require that IAM user passwords contain at least one uppercase character from the ISO basic Latin alphabet (A to Z).
    Type: String
  pResourceTypes:
    AllowedPattern: "^$|^([0-9a-zA-Z]+::[0-9a-zA-Z]+::[0-9a-zA-Z]+)$|^(([0-9a-zA-Z]+::[0-9a-zA-Z]+::[0-9a-zA-Z]+(,|, ))*[0-9a-zA-Z]+::[0-9a-zA-Z]+::[0-9a-zA-Z]+)$"
    Default: ""
    Description:
      (Optional) A list of valid AWS resource types to include in this recording group. Eg. AWS::CloudTrail::Trail. If 'All Supported' parameter is
      set to 'false', then this parameter becomes required.
    Type: String
  pSRAAlarmEmail:
    Description: (Optional) Email address for receiving SRA alarms
    Type: String
  pCreateAWSControlTowerExecutionRole:
    AllowedValues: ["true", "false"]
    Default: "true"
    Description: Indicates whether the AWS Control Tower Execution role should be created.
    Type: String
  pSecurityContactAction:
    AllowedValues: ["add", "delete", "ignore"]
    Default: add
    Description: Indicates whether to add, delete, or ignore the Security alternate contact.
    Type: String
  pSecurityEmail:
    AllowedPattern: '^$|^([a-zA-Z0-9_.+-]+@[a-zA-Z0-9-]+\.[a-zA-Z0-9-.]+)$'
    ConstraintDescription: Email Validation as per RFC2822 standards.
    Default: ""
    Description:
      (Optional) Email Address for Security alternate contact. If 'Security Alternate Contact Action' parameter is set to 'add', then this parameter
      becomes required.
    Type: String
  pSecurityName:
    AllowedPattern: '^(?![&<>\\%|]).*$'
    ConstraintDescription: All characters allowed except '&<>\%|'
    Default: ""
    Description:
      (Optional) Full Name for Security alternate contact. If 'Security Alternate Contact Action' parameter is set to 'add', then this parameter
      becomes required.
    Type: String
  pSecurityPhone:
    AllowedPattern: '^$|^[\s0-9()+-]+$'
    ConstraintDescription: Must be numbers, special characters [()+-], and/or whitespace
    Default: ""
    Description:
      (Optional) Phone Number for Security alternate contact. If 'Security Alternate Contact Action' parameter is set to 'add', then this parameter
      becomes required.
    Type: String
  pSecurityTitle:
    AllowedPattern: '^(?![&<>\\%|]).*$'
    ConstraintDescription: All characters allowed except '&<>\%|'
    Default: ""
    Description:
      (Optional) Title for Security alternate contact. If 'Security Alternate Contact Action' parameter is set to 'add', then this parameter becomes
      required.
    Type: String
  pVPCCidrBlock:
    AllowedPattern: '^$|^([0-9]{1,3}\.){3}[0-9]{1,3}(\/([0-9]|[1-2][0-9]|3[0-2]))?$'
    ConstraintDescription: CIDR block parameter must be in the form x.x.x.x/16-28
    Default: 10.0.0.0/28
    Description: VPC CIDR Block to use for the new VPC. Only used if Create VPC is true.
    Type: String
  pVpcId:
    AllowedPattern: "^$|^vpc-[0-9a-f]{17}$"
    ConstraintDescription: Must have a prefix of "vpc-". Followed by 17 characters (numbers, letters "a-f")
    Default: ""
    Description: (Optional) Existing VPC ID for the Firewall Manager Security Groups. Required if Create VPC For Security Group is "false".
    Type: String

  pDeployShieldSolution:
    AllowedValues: ["Yes", "No"]
    Default: "No"
    Description: Deploy the AWS Shield Advanced solution.
    Type: String
  pConfigureDRTTeamAccess:
    AllowedValues: ["true", "false"]
    Default: "true"
    Description: Allow the DDOS response team access to the AWS account(s)
    Type: String
  pResourcesToProtect:
    Description:
      Enables AWS Shield Advanced for a specific AWS resource. The resource can be an Amazon CloudFront distribution, Elastic Load Balancing load
      balancer, Elastic IP Address, or an Amazon Route 53 hosted zone.
    Type: CommaDelimitedList
    Default: "arn:aws:cloudfront::111111111111:distribution/ABCDEFGHIJKLMN"
  pShieldAccountsToProtect:
    AllowedPattern: '^(ALL|(\d{12})(,(\d{12}))*?)$'
    ConstraintDescription: 'Enter "ALL" or a comma-separated list of AWS account numbers without spaces, e.g., "123456789012,234567890123"'
    Description:
      Accounts to enable shield advanced. Choose ALL to enable for all accounts in your AWS Organization to choose the accounts enter a comma
      seperated list of the AWS Account numbers
    Type: CommaDelimitedList
    Default: "111111111111"
  pShieldDRTRoleName:
    AllowedValues: ["DRT-Access-Role"]
    Default: "DRT-Access-Role"
    ConstraintDescription: "Enter a valid IAM role name (1-64 characters), using only alphanumeric characters and allowed special characters: +=,.@_-"
    Description: Name of the IAM role to create and grant access to the DRT
    Type: String
  pShieldAutoRenew:
    AllowedValues: ["ENABLED", "DISABLED"]
    Default: "ENABLED"
    Description: Determines if Shield Advanced subscription is Auto Renewed
    Type: String
  pShieldDRTLogBuckets:
    AllowedPattern: "^((?!xn--)(?!.*-s3alias$)[a-z0-9][a-z0-9-]{1,61}[a-z0-9])$"
    ConstraintDescription: 'A comma-separated list of AWS S3 buckets without spaces to give the DRT Team access to e.g., "samplebucket1,samplebucket2"'
    Description: A list of up to 10 S3 bucket names per account to give the DDOS Response team access to flow logs
    Type: CommaDelimitedList
    Default: "samplebucket1"
  pShieldWarning:
    AllowedValues: ["Accept", "Reject"]
    Default: "Reject"
    Description: Disclaimer Shield Advanced requires a 1 year commitment and cost $3000 per month. For details see https://aws.amazon.com/shield/pricing/
    Type: String
  pProtectionGroup0AccountId:
    AllowedPattern: '^$|^\d{12}$'
    ConstraintDescription: 12 digit AWS Account Number
    Default: ""
    Description: The 12 digit account number where the protection group is to be created
    Type: String
  pProtectionGroup0Id:
    AllowedPattern: "^[a-zA-Z0-9]{0,64}$|^$"
    ConstraintDescription: A valid name using alphanumeric characters
    Default: ""
    Description: The name of the protection group
    Type: String
  pProtectionGroup0Aggregation:
    AllowedValues: ["SUM", "MEAN", "MAX", ""]
    Default: ""
    Description: Defines how Shield combines resource data for the group in order to detect, mitigate, and report events.
    Type: String
  pProtectionGroup0Pattern:
    AllowedValues: [ALL, ARBITRARY, BY_RESOURCE_TYPE, ""]
    Default: ""
    Description: The criteria to use to choose the protected resources for inclusion in the group. You can include all resources that have protections, provide a list of resource Amazon Resource Names (ARNs), or include all resources of a specified resource type.
    Type: String
  pProtectionGroup0ResourceType:
    AllowedValues:
      [
        CLOUDFRONT_DISTRIBUTION,
        ROUTE_53_HOSTED_ZONE,
        ELASTIC_IP_ALLOCATION,
        CLASSIC_LOAD_BALANCER,
        APPLICATION_LOAD_BALANCER,
        GLOBAL_ACCELERATOR,
        "",
      ]
    Default: ""
    Description: The resource type to include in the protection group. All protected resources of this type are included in the protection group. Newly protected resources of this type are automatically added to the group. You must set this when you set Pattern to BY_RESOURCE_TYPE and you must not set it for any other Pattern setting.
    Type: String
  pProtectionGroup0Members:
    AllowedPattern: "^arn:aws:.*$|^$"
    ConstraintDescription: List of ARNs of resources to include in the protection group. You must set this when you set Pattern to ARBITRARY and you must not set it for any other Pattern setting.
    Default: ""
    Description: The Amazon Resource Names (ARNs) of the resources to include in the protection group. You must set this when you set Pattern to ARBITRARY and you must not set it for any other Pattern setting.
    Type: CommaDelimitedList
  pProtectionGroup1AccountId:
    AllowedPattern: '^$|^\d{12}$'
    ConstraintDescription: 12 digit AWS Account Number
    Default: ""
    Description: The 12 digit account number where the protection group is to be created
    Type: String
  pProtectionGroup1Id:
    AllowedPattern: "^[a-zA-Z0-9]{0,64}$|^$"
    ConstraintDescription: A valid name using alphanumeric characters
    Default: ""
    Description: The name of the protection group
    Type: String
  pProtectionGroup1Aggregation:
    AllowedValues: ["SUM", "MEAN", "MAX", ""]
    Default: ""
    Description: Defines how Shield combines resource data for the group in order to detect, mitigate, and report events.
    Type: String
  pProtectionGroup1Pattern:
    AllowedValues: [ALL, ARBITRARY, BY_RESOURCE_TYPE, ""]
    Default: ""
    Description: The criteria to use to choose the protected resources for inclusion in the group. You can include all resources that have protections, provide a list of resource Amazon Resource Names (ARNs), or include all resources of a specified resource type.
    Type: String
  pProtectionGroup1ResourceType:
    AllowedValues:
      [
        CLOUDFRONT_DISTRIBUTION,
        ROUTE_53_HOSTED_ZONE,
        ELASTIC_IP_ALLOCATION,
        CLASSIC_LOAD_BALANCER,
        APPLICATION_LOAD_BALANCER,
        GLOBAL_ACCELERATOR,
        "",
      ]
    Default: ""
    Description: The resource type to include in the protection group. All protected resources of this type are included in the protection group. Newly protected resources of this type are automatically added to the group. You must set this when you set Pattern to BY_RESOURCE_TYPE and you must not set it for any other Pattern setting.
    Type: String
  pProtectionGroup1Members:
    AllowedPattern: "^arn:aws:.*$|^$"
    ConstraintDescription: Must be a valid arn or list of arns
    Default: ""
    Description: The Amazon Resource Names (ARNs) of the resources to include in the protection group. You must set this when you set Pattern to ARBITRARY and you must not set it for any other Pattern setting.
    Type: CommaDelimitedList
  pProtectionGroup2AccountId:
    AllowedPattern: '^$|^\d{12}$'
    ConstraintDescription: 12 digit AWS Account Number
    Default: ""
    Description: The 12 digit account number where the protection group is to be created
    Type: String
  pProtectionGroup2Id:
    AllowedPattern: "^[a-zA-Z0-9]{0,64}$|^$"
    ConstraintDescription: A valid name using alphanumeric characters
    Default: ""
    Description: The name of the protection group
    Type: String
  pProtectionGroup2Aggregation:
    AllowedValues: ["SUM", "MEAN", "MAX", ""]
    Default: ""
    Description: Defines how Shield combines resource data for the group in order to detect, mitigate, and report events.
    Type: String
  pProtectionGroup2Pattern:
    AllowedValues: [ALL, ARBITRARY, BY_RESOURCE_TYPE, ""]
    Default: ""
    Description: The criteria to use to choose the protected resources for inclusion in the group. You can include all resources that have protections, provide a list of resource Amazon Resource Names (ARNs), or include all resources of a specified resource type.
    Type: String
  pProtectionGroup2ResourceType:
    AllowedValues:
      [
        CLOUDFRONT_DISTRIBUTION,
        ROUTE_53_HOSTED_ZONE,
        ELASTIC_IP_ALLOCATION,
        CLASSIC_LOAD_BALANCER,
        APPLICATION_LOAD_BALANCER,
        GLOBAL_ACCELERATOR,
        "",
      ]
    Default: ""
    Description: The resource type to include in the protection group. All protected resources of this type are included in the protection group. Newly protected resources of this type are automatically added to the group. You must set this when you set Pattern to BY_RESOURCE_TYPE and you must not set it for any other Pattern setting.
    Type: String
  pProtectionGroup2Members:
    AllowedPattern: "^arn:aws:.*$|^$"
    ConstraintDescription: Must be a valid arn or list of arns
    Default: ""
    Description: The Amazon Resource Names (ARNs) of the resources to include in the protection group. You must set this when you set Pattern to ARBITRARY and you must not set it for any other Pattern setting.
    Type: CommaDelimitedList
  pProtectionGroup3AccountId:
    AllowedPattern: '^$|^\d{12}$'
    ConstraintDescription: 12 digit AWS Account Number
    Default: ""
    Description: The 12 digit account number where the protection group is to be created
    Type: String
  pProtectionGroup3Id:
    AllowedPattern: "^[a-zA-Z0-9]{0,64}$|^$"
    ConstraintDescription: A valid name using alphanumeric characters
    Default: ""
    Description: The name of the protection group
    Type: String
  pProtectionGroup3Aggregation:
    AllowedValues: ["SUM", "MEAN", "MAX", ""]
    Default: ""
    Description: Defines how Shield combines resource data for the group in order to detect, mitigate, and report events.
    Type: String
  pProtectionGroup3Pattern:
    AllowedValues: [ALL, ARBITRARY, BY_RESOURCE_TYPE, ""]
    Default: ""
    Description: The criteria to use to choose the protected resources for inclusion in the group. You can include all resources that have protections, provide a list of resource Amazon Resource Names (ARNs), or include all resources of a specified resource type.
    Type: String
  pProtectionGroup3ResourceType:
    AllowedValues:
      [
        CLOUDFRONT_DISTRIBUTION,
        ROUTE_53_HOSTED_ZONE,
        ELASTIC_IP_ALLOCATION,
        CLASSIC_LOAD_BALANCER,
        APPLICATION_LOAD_BALANCER,
        GLOBAL_ACCELERATOR,
        "",
      ]
    Default: ""
    Description: The resource type to include in the protection group. All protected resources of this type are included in the protection group. Newly protected resources of this type are automatically added to the group. You must set this when you set Pattern to BY_RESOURCE_TYPE and you must not set it for any other Pattern setting.
    Type: String
  pProtectionGroup3Members:
    AllowedPattern: "^arn:aws:.*$|^$"
    ConstraintDescription: Must be a valid arn or list of arns
    Default: ""
    Description: The Amazon Resource Names (ARNs) of the resources to include in the protection group. You must set this when you set Pattern to ARBITRARY and you must not set it for any other Pattern setting.
    Type: CommaDelimitedList
  pProtectionGroup4AccountId:
    AllowedPattern: '^$|^\d{12}$'
    ConstraintDescription: 12 digit AWS Account Number
    Default: ""
    Description: The 12 digit account number where the protection group is to be created
    Type: String
  pProtectionGroup4Id:
    AllowedPattern: "^[a-zA-Z0-9]{0,64}$|^$"
    ConstraintDescription: A valid name using alphanumeric characters
    Default: ""
    Description: The name of the protection group
    Type: String
  pProtectionGroup4Aggregation:
    AllowedValues: ["SUM", "MEAN", "MAX", ""]
    Default: ""
    Description: Defines how Shield combines resource data for the group in order to detect, mitigate, and report events.
    Type: String
  pProtectionGroup4Pattern:
    AllowedValues: [ALL, ARBITRARY, BY_RESOURCE_TYPE, ""]
    Default: ""
    Description: The criteria to use to choose the protected resources for inclusion in the group. You can include all resources that have protections, provide a list of resource Amazon Resource Names (ARNs), or include all resources of a specified resource type.
    Type: String
  pProtectionGroup4ResourceType:
    AllowedValues:
      [
        CLOUDFRONT_DISTRIBUTION,
        ROUTE_53_HOSTED_ZONE,
        ELASTIC_IP_ALLOCATION,
        CLASSIC_LOAD_BALANCER,
        APPLICATION_LOAD_BALANCER,
        GLOBAL_ACCELERATOR,
        "",
      ]
    Default: ""
    Description: The resource type to include in the protection group. All protected resources of this type are included in the protection group. Newly protected resources of this type are automatically added to the group. You must set this when you set Pattern to BY_RESOURCE_TYPE and you must not set it for any other Pattern setting.
    Type: String
  pProtectionGroup4Members:
    AllowedPattern: "^arn:aws:.*$|^$"
    ConstraintDescription: Must be a valid arn or list of arns
    Default: ""
    Description: The Amazon Resource Names (ARNs) of the resources to include in the protection group. You must set this when you set Pattern to ARBITRARY and you must not set it for any other Pattern setting.
    Type: CommaDelimitedList
  pShieldEnableProactiveEngagement:
    AllowedValues: ["true", "false"]
    Default: "false"
    Description: Enable Shield Advanced Proactive Engagement
    Type: String
  pShieldProactiveEngagementEmail:
    AllowedPattern: '^$|^[a-zA-Z0-9_.+-]+@[a-zA-Z0-9-]+\.[a-zA-Z0-9-.]+$|^$'
    ConstraintDescription: Must be a valid email address
    Default: ""
    Description: Shield Advanced Proactive Engagement Email Address
    Type: String
  pShieldProactiveEngagementPhoneNumber:
    AllowedPattern: "^$|^[+][1-9][0-9]{1,14}$|^$"
    ConstraintDescription: Must be a valid phone number
    Default: ""
    Description: "Shield Advanced Proactive Engagement Phone Number (ex: +15555555555)"
    Type: String
  pShieldProactiveEngagementNotes:
    AllowedPattern: "^$|^[a-zA-Z0-9_ ]+$|^$"
    ConstraintDescription: Must be a valid string
    Default: ""
    Description: Shield Advanced Proactive Engagement Notes
    Type: String

  pDeployPatchMgrSolution:
    AllowedValues: ["Yes", "No"]
    Default: "No"
    Description: Deploy the Patch Manager solution.
    Type: String
  pPatchMgmtRoleName:
    AllowedValues: ["sra-patch-mgmt-configuration"]
    Default: "sra-patch-mgmt-configuration"
    Description: Patch Management Role Name
    Type: String
  # Window 1
  pPatchMgmtMaintWindow1Name:
    AllowedPattern: '^[a-zA-Z0-9-_\s]{3,128}$'
    ConstraintDescription: Maintenance Window name can include numbers, lowercase letters, uppercase letters, and hyphens (-). It cannot start or end with a hyphen (-).
    Description: Patch Management Maintenance Window 1 Name
    Default: Update_SSM
    Type: String
  pPatchMgmtMaintWindow1Desc:
    AllowedPattern: '^[a-zA-Z0-9-_\s]{3,128}$'
    ConstraintDescription: Maintenance Window description can include numbers, lowercase letters, uppercase letters, and hyphens (-). It cannot start or end with a hyphen (-).
    Description: Patch Management Maintenance Window 1 Description
    Default: Maintenance Window update the SSM Agent on managed Instances
    Type: String
  pPatchMgmtMaintWindow1Schedule:
    AllowedPattern: '^(rate\(((1 (hour|minute|day))|(\d+(hours|minutes|days)))\))|(cron\(\s*($|#|\w+\s*=|(\?|\*|(?:[0-5]?\d)(?:(?:-|/|\,)(?:[0-5]?\d))?(?:,(?:[0-5]?\d)(?:(?:-|/|\,)(?:[0-5]?\d))?)*)\s+(\?|\*|(?:[0-5]?\d)(?:(?:-|/|\,)(?:[0-5]?\d))?(?:,(?:[0-5]?\d)(?:(?:-|/|\,)(?:[0-5]?\d))?)*)\s+(\?|\*|(?:[01]?\d|2[0-3])(?:(?:-|/|\,)(?:[01]?\d|2[0-3]))?(?:,(?:[01]?\d|2[0-3])(?:(?:-|/|\,)(?:[01]?\d|2[0-3]))?)*)\s+(\?|\*|(?:0?[1-9]|[12]\d|3[01])(?:(?:-|/|\,)(?:0?[1-9]|[12]\d|3[01]))?(?:,(?:0?[1-9]|[12]\d|3[01])(?:(?:-|/|\,)(?:0?[1-9]|[12]\d|3[01]))?)*)\s+(\?|\*|(?:[1-9]|1[012])(?:(?:-|/|\,)(?:[1-9]|1[012]))?(?:L|W)?(?:,(?:[1-9]|1[012])(?:(?:-|/|\,)(?:[1-9]|1[012]))?(?:L|W)?)*|\?|\*|(?:JAN|FEB|MAR|APR|MAY|JUN|JUL|AUG|SEP|OCT|NOV|DEC)(?:(?:-)(?:JAN|FEB|MAR|APR|MAY|JUN|JUL|AUG|SEP|OCT|NOV|DEC))?(?:,(?:JAN|FEB|MAR|APR|MAY|JUN|JUL|AUG|SEP|OCT|NOV|DEC)(?:(?:-)(?:JAN|FEB|MAR|APR|MAY|JUN|JUL|AUG|SEP|OCT|NOV|DEC))?)*)\s+(\?|\*|(?:[0-6])(?:(?:-|/|\,|#)(?:[0-6]))?(?:L)?(?:,(?:[0-6])(?:(?:-|/|\,|#)(?:[0-6]))?(?:L)?)*|\?|\*|(?:MON|TUE|WED|THU|FRI|SAT|SUN)(?:(?:-)(?:MON|TUE|WED|THU|FRI|SAT|SUN))?(?:,(?:MON|TUE|WED|THU|FRI|SAT|SUN)(?:(?:-)(?:MON|TUE|WED|THU|FRI|SAT|SUN))?)*)(|\s)+(\?|\*|(?:|\d{4})(?:(?:-|/|\,)(?:|\d{4}))?(?:,(?:|\d{4})(?:(?:-|/|\,)(?:|\d{4}))?)*))\))$'
    Description: Patch Management Maintenance Window 1 schedule
    Default: "cron(0 0 1 ? * THU *)"
    Type: String
  pPatchMgmtMaintWindow1Duration:
    ConstraintDescription: Must be a number between 1 and 24.
    Description: Patch Management Maintenance Window 1 Duration (hrs)
    Default: 6
    Type: Number
    MinValue: 1
    MaxValue: 24
  pPatchMgmtMaintWindow1Cutoff:
    Description: Stop initiating tasks before maintenance window ends (hrs)
    Default: 1
    Type: Number
    MinValue: 0
    MaxValue: 23
  pPatchMgmtMaintWindow1TZ:
    Description: Patch Management Maintenance Window 1 Timezone
    Default: America/New_York
    AllowedValues:
      - America/New_York
      - America/Chicago
      - America/Los_Angeles
      - America/Denver
      - America/Phoenix
      - America/Edmonton
      - America/Halifax
      - America/Whitehorse
      - America/Yellowknife
      - America/Nipigon
      - America/Indiana/Indianapolis
      - America/Indiana/Knox
      - America/Indiana/Muncie
      - America/Indiana/Portage
      - America/Indiana/Vincennes
      - America/Indiana/Winamac
      - America/Indiana/Terre_Haute
      - America/Monterey
      - America/Louisville
      - America/Montreal
      - America/Nassau
      - America/New_York
      - America/Detroit
      - America/Tijuana
      - America/Toronto
      - America/Vancouver
      - America/Edmonton
      - America/Yellowknife
      - America/Nipigon
      - America/Indiana/Indianapolis
      - America/Indiana/Knox
      - America/Indiana/Muncie
      - America/Indiana/Portage
      - America/Indiana/Vincennes
      - America/Indiana/Winamac
      - America/Indiana/Terre_Haute
      - America/Monterey
      - America/Louisville
      - America/Montreal
      - America/Nassau
      - America/New_York
      - America/Detroit
      - America/Tijuana
      - America/Toronto
      - America/Vancouver
      - Europe/Amsterdam
      - Europe/Belgrade
      - Europe/Berlin
      - Europe/Brussels
      - Europe/Dublin
      - Europe/Gibraltar
      - Europe/Helsinki
      - Europe/Kyiv
      - Europe/Lisbon
      - Europe/London
      - Europe/Luxembourg
      - Europe/Madrid
      - Europe/Malta
      - Europe/Monaco
      - Europe/Moscow
      - Europe/Oslo
      - Europe/Paris
      - Europe/Podgorica
      - Europe/Prague
      - Europe/Rome
      - Europe/Sarajevo
      - Europe/Skopje
      - Europe/Stockholm
      - Europe/Tirane
      - Europe/Tromsø
      - Europe/Vatican
      - Europe/Vienna
      - Europe/Warsaw
      - Europe/Zagreb
      - Europe/Zurich
    Type: String
  pPatchMgmtTask1Name:
    AllowedPattern: '^[a-zA-Z0-9-_\s]{3,128}$'
    ConstraintDescription: Maintenance Window Task Name can include numbers, lowercase letters, uppercase letters, and hyphens (-). It cannot start or end with a hyphen (-).
    Description: Patch Management Task 1 Name
    Type: String
    Default: Update_SSMAgent
  pPatchMgmtTask1Desc:
    AllowedPattern: '^[a-zA-Z0-9-_\s]{3,128}$'
    ConstraintDescription: Maintenance Window Task Description can include numbers, lowercase letters, uppercase letters, and hyphens (-). It cannot start or end with a hyphen (-).
    Description: Patch Management Task 1 Description
    Default: Task to update SSM Agent on all managed Instances
    Type: String
  pPatchMgmtTask1Operation:
    AllowedValues: ["Scan", "Install"]
    ConstraintDescription: Maintenance Window Task Operation can be either Scan or Install.
    Description: Patch Management Task can be configured to either scan for patches or install patches.
    Default: Scan
    Type: String
  pPatchMgmtTask1RebootOption:
    AllowedValues: ["RebootIfNeeded", "NoReboot"]
    ConstraintDescription: Maintenance Window Task Reboot Option can be either Reboot If Needed or No Reboot.
    Description: Patch Management Task can be configured to either Reboot or Not Reboot.
    Default: RebootIfNeeded
    Type: String
  pPatchMgmtTask1RunCmd:
    AllowedValues: [AWS-UpdateSSMAgent]
    Description: Patch Management Task 1 Run Command
    Default: AWS-UpdateSSMAgent
    Type: String
  pPatchMgmtTarget1Name:
    AllowedPattern: '^[a-zA-Z0-9-_\s]{3,128}$'
    ConstraintDescription: Maintenance Window Target Name can include numbers, lowercase letters, uppercase letters, and hyphens (-). It cannot start or end with a hyphen (-).
    Description: Patch Management Target 1 Name
    Default: AWS_UpdateSSMAgent
    Type: String
  pPatchMgmtTarget1Desc:
    AllowedPattern: '^[a-zA-Z0-9-_\s]{3,128}$'
    ConstraintDescription: Maintenance Window Target Desription can include numbers, lowercase letters, uppercase letters, and hyphens (-). It cannot start or end with a hyphen (-).
    Description: Patch Management Target 1 Description
    Default: Targets to run the command to update SSM Agent
    Type: String
  pPatchMgmtTarget1Value1:
    AllowedValues: [Linux]
    Description: Patch Management Tag Value of Target group 1
    Default: Linux
    Type: String
  pPatchMgmtTarget1Value2:
    AllowedValues: [Windows]
    Description: Patch Management Tag Value of Target group 1
    Default: Windows
    Type: String
  # Window 2
  pPatchMgmtMaintWindow2Name:
    AllowedPattern: '^[a-zA-Z0-9-_\s]{3,128}$'
    ConstraintDescription: Maintenance Window name can include numbers, lowercase letters, uppercase letters, and hyphens (-). It cannot start or end with a hyphen (-).
    Description: Patch Management Maintenance Window 2 Name
    Default: Windows_Scan
    Type: String
  pPatchMgmtMaintWindow2Desc:
    AllowedPattern: '^[a-zA-Z0-9-_\s]{3,128}$'
    ConstraintDescription: Maintenance Window description can include numbers, lowercase letters, uppercase letters, and hyphens (-). It cannot start or end with a hyphen (-).
    Description: Patch Management Maintenance Window Description
    Default: Maintenance Window to scan Windows Instances
    Type: String
  pPatchMgmtMaintWindow2Schedule:
    AllowedPattern: '^(rate\(((1 (hour|minute|day))|(\d+(hours|minutes|days)))\))|(cron\(\s*($|#|\w+\s*=|(\?|\*|(?:[0-5]?\d)(?:(?:-|/|\,)(?:[0-5]?\d))?(?:,(?:[0-5]?\d)(?:(?:-|/|\,)(?:[0-5]?\d))?)*)\s+(\?|\*|(?:[0-5]?\d)(?:(?:-|/|\,)(?:[0-5]?\d))?(?:,(?:[0-5]?\d)(?:(?:-|/|\,)(?:[0-5]?\d))?)*)\s+(\?|\*|(?:[01]?\d|2[0-3])(?:(?:-|/|\,)(?:[01]?\d|2[0-3]))?(?:,(?:[01]?\d|2[0-3])(?:(?:-|/|\,)(?:[01]?\d|2[0-3]))?)*)\s+(\?|\*|(?:0?[1-9]|[12]\d|3[01])(?:(?:-|/|\,)(?:0?[1-9]|[12]\d|3[01]))?(?:,(?:0?[1-9]|[12]\d|3[01])(?:(?:-|/|\,)(?:0?[1-9]|[12]\d|3[01]))?)*)\s+(\?|\*|(?:[1-9]|1[012])(?:(?:-|/|\,)(?:[1-9]|1[012]))?(?:L|W)?(?:,(?:[1-9]|1[012])(?:(?:-|/|\,)(?:[1-9]|1[012]))?(?:L|W)?)*|\?|\*|(?:JAN|FEB|MAR|APR|MAY|JUN|JUL|AUG|SEP|OCT|NOV|DEC)(?:(?:-)(?:JAN|FEB|MAR|APR|MAY|JUN|JUL|AUG|SEP|OCT|NOV|DEC))?(?:,(?:JAN|FEB|MAR|APR|MAY|JUN|JUL|AUG|SEP|OCT|NOV|DEC)(?:(?:-)(?:JAN|FEB|MAR|APR|MAY|JUN|JUL|AUG|SEP|OCT|NOV|DEC))?)*)\s+(\?|\*|(?:[0-6])(?:(?:-|/|\,|#)(?:[0-6]))?(?:L)?(?:,(?:[0-6])(?:(?:-|/|\,|#)(?:[0-6]))?(?:L)?)*|\?|\*|(?:MON|TUE|WED|THU|FRI|SAT|SUN)(?:(?:-)(?:MON|TUE|WED|THU|FRI|SAT|SUN))?(?:,(?:MON|TUE|WED|THU|FRI|SAT|SUN)(?:(?:-)(?:MON|TUE|WED|THU|FRI|SAT|SUN))?)*)(|\s)+(\?|\*|(?:|\d{4})(?:(?:-|/|\,)(?:|\d{4}))?(?:,(?:|\d{4})(?:(?:-|/|\,)(?:|\d{4}))?)*))\))$'
    Description: Patch Management Maintenance Window 2 schedule
    Default: "cron(0 0 1 ? * WED *)"
    Type: String
  pPatchMgmtMaintWindow2Duration:
    ConstraintDescription: Must be a number between 1 and 24.
    Description: Patch Management Maintenance Window 2 Duration (hrs)
    Default: 6
    Type: Number
    MinValue: 1
    MaxValue: 24
  pPatchMgmtMaintWindow2Cutoff:
    Description: Stop initiating tasks before maintenance window ends (hrs)
    Default: 1
    Type: Number
    MinValue: 0
    MaxValue: 23
  pPatchMgmtMaintWindow2TZ:
    Description: Patch Management Maintenance Window 2 Timezone
    Default: America/New_York
    AllowedValues:
      - America/New_York
      - America/Chicago
      - America/Los_Angeles
      - America/Denver
      - America/Phoenix
      - America/Edmonton
      - America/Halifax
      - America/Whitehorse
      - America/Yellowknife
      - America/Nipigon
      - America/Indiana/Indianapolis
      - America/Indiana/Knox
      - America/Indiana/Muncie
      - America/Indiana/Portage
      - America/Indiana/Vincennes
      - America/Indiana/Winamac
      - America/Indiana/Terre_Haute
      - America/Monterey
      - America/Louisville
      - America/Montreal
      - America/Nassau
      - America/New_York
      - America/Detroit
      - America/Tijuana
      - America/Toronto
      - America/Vancouver
      - America/Edmonton
      - America/Yellowknife
      - America/Nipigon
      - America/Indiana/Indianapolis
      - America/Indiana/Knox
      - America/Indiana/Muncie
      - America/Indiana/Portage
      - America/Indiana/Vincennes
      - America/Indiana/Winamac
      - America/Indiana/Terre_Haute
      - America/Monterey
      - America/Louisville
      - America/Montreal
      - America/Nassau
      - America/New_York
      - America/Detroit
      - America/Tijuana
      - America/Toronto
      - America/Vancouver
      - Europe/Amsterdam
      - Europe/Belgrade
      - Europe/Berlin
      - Europe/Brussels
      - Europe/Dublin
      - Europe/Gibraltar
      - Europe/Helsinki
      - Europe/Kyiv
      - Europe/Lisbon
      - Europe/London
      - Europe/Luxembourg
      - Europe/Madrid
      - Europe/Malta
      - Europe/Monaco
      - Europe/Moscow
      - Europe/Oslo
      - Europe/Paris
      - Europe/Podgorica
      - Europe/Prague
      - Europe/Rome
      - Europe/Sarajevo
      - Europe/Skopje
      - Europe/Stockholm
      - Europe/Tirane
      - Europe/Tromsø
      - Europe/Vatican
      - Europe/Vienna
      - Europe/Warsaw
      - Europe/Zagreb
      - Europe/Zurich
    Type: String
  pPatchMgmtTask2Name:
    AllowedPattern: '^[a-zA-Z0-9-_\s]{3,128}$'
    ConstraintDescription: Maintenance Window Task Name can include numbers, lowercase letters, uppercase letters, and hyphens (-). It cannot start or end with a hyphen (-).
    Description: Patch Management Task 2 Name
    Type: String
    Default: Windows_Scan
  pPatchMgmtTask2Desc:
    AllowedPattern: '^[a-zA-Z0-9-_\s]{3,128}$'
    ConstraintDescription: Maintenance Window Task Description can include numbers, lowercase letters, uppercase letters, and hyphens (-). It cannot start or end with a hyphen (-).
    Description: Patch Management Task 2 Description
    Default: Task to scan Windows Instances
    Type: String
  pPatchMgmtTask2Operation:
    AllowedValues: ["Scan", "Install"]
    ConstraintDescription: Maintenance Window Task Operation can be either Scan or Install.
    Description: Patch Management Task can be configured to either scan for patches or install patches.
    Default: Scan
    Type: String
  pPatchMgmtTask2RebootOption:
    AllowedValues: ["RebootIfNeeded", "NoReboot"]
    ConstraintDescription: Maintenance Window Task Reboot Option can be either Reboot If Needed or No Reboot.
    Description: Patch Management Task can be configured to either Reboot or Not Reboot.
    Default: RebootIfNeeded
    Type: String
  pPatchMgmtTask2RunCmd:
    AllowedValues: [AWS-RunPatchBaseline]
    Description: Patch Management Task 2 Run Command
    Default: AWS-RunPatchBaseline
    Type: String
  pPatchMgmtTarget2Name:
    AllowedPattern: '^[a-zA-Z0-9-_\s]{3,128}$'
    ConstraintDescription: Maintenance Window Target Name can include numbers, lowercase letters, uppercase letters, and hyphens (-). It cannot start or end with a hyphen (-).
    Description: Patch Management Target 2 Name
    Default: Windows_Scan
    Type: String
  pPatchMgmtTarget2Desc:
    AllowedPattern: '^[a-zA-Z0-9-_\s]{3,128}$'
    ConstraintDescription: Maintenance Window Target Desription can include numbers, lowercase letters, uppercase letters, and hyphens (-). It cannot start or end with a hyphen (-).
    Description: Patch Management Target 2 Description
    Default: Targets to run the command to scan for Windows updates
    Type: String
  pPatchMgmtTarget2Value1:
    AllowedValues: [Windows]
    Description: Patch Management Tag Value of Target group 2
    Default: Windows
    Type: String
  # Window 3
  pPatchMgmtMaintWindow3Name:
    AllowedPattern: '^[a-zA-Z0-9-_\s]{3,128}$'
    ConstraintDescription: Maintenance Window name can include numbers, lowercase letters, uppercase letters, and hyphens (-). It cannot start or end with a hyphen (-).
    Description: Patch Management Maintenance Window 3 Name
    Default: Linux_Scan
    Type: String
  pPatchMgmtMaintWindow3Desc:
    AllowedPattern: '^[a-zA-Z0-9-_\s]{3,128}$'
    ConstraintDescription: Maintenance Window description can include numbers, lowercase letters, uppercase letters, and hyphens (-). It cannot start or end with a hyphen (-).
    Description: Patch Management Maintenance Window 3 Description
    Default: Maintenance Window scan Linux Instances
    Type: String
  pPatchMgmtMaintWindow3Schedule:
    AllowedPattern: '^(rate\(((1 (hour|minute|day))|(\d+(hours|minutes|days)))\))|(cron\(\s*($|#|\w+\s*=|(\?|\*|(?:[0-5]?\d)(?:(?:-|/|\,)(?:[0-5]?\d))?(?:,(?:[0-5]?\d)(?:(?:-|/|\,)(?:[0-5]?\d))?)*)\s+(\?|\*|(?:[0-5]?\d)(?:(?:-|/|\,)(?:[0-5]?\d))?(?:,(?:[0-5]?\d)(?:(?:-|/|\,)(?:[0-5]?\d))?)*)\s+(\?|\*|(?:[01]?\d|2[0-3])(?:(?:-|/|\,)(?:[01]?\d|2[0-3]))?(?:,(?:[01]?\d|2[0-3])(?:(?:-|/|\,)(?:[01]?\d|2[0-3]))?)*)\s+(\?|\*|(?:0?[1-9]|[12]\d|3[01])(?:(?:-|/|\,)(?:0?[1-9]|[12]\d|3[01]))?(?:,(?:0?[1-9]|[12]\d|3[01])(?:(?:-|/|\,)(?:0?[1-9]|[12]\d|3[01]))?)*)\s+(\?|\*|(?:[1-9]|1[012])(?:(?:-|/|\,)(?:[1-9]|1[012]))?(?:L|W)?(?:,(?:[1-9]|1[012])(?:(?:-|/|\,)(?:[1-9]|1[012]))?(?:L|W)?)*|\?|\*|(?:JAN|FEB|MAR|APR|MAY|JUN|JUL|AUG|SEP|OCT|NOV|DEC)(?:(?:-)(?:JAN|FEB|MAR|APR|MAY|JUN|JUL|AUG|SEP|OCT|NOV|DEC))?(?:,(?:JAN|FEB|MAR|APR|MAY|JUN|JUL|AUG|SEP|OCT|NOV|DEC)(?:(?:-)(?:JAN|FEB|MAR|APR|MAY|JUN|JUL|AUG|SEP|OCT|NOV|DEC))?)*)\s+(\?|\*|(?:[0-6])(?:(?:-|/|\,|#)(?:[0-6]))?(?:L)?(?:,(?:[0-6])(?:(?:-|/|\,|#)(?:[0-6]))?(?:L)?)*|\?|\*|(?:MON|TUE|WED|THU|FRI|SAT|SUN)(?:(?:-)(?:MON|TUE|WED|THU|FRI|SAT|SUN))?(?:,(?:MON|TUE|WED|THU|FRI|SAT|SUN)(?:(?:-)(?:MON|TUE|WED|THU|FRI|SAT|SUN))?)*)(|\s)+(\?|\*|(?:|\d{4})(?:(?:-|/|\,)(?:|\d{4}))?(?:,(?:|\d{4})(?:(?:-|/|\,)(?:|\d{4}))?)*))\))$'
    Description: Patch Management Maintenance Window 3 schedule
    Default: "cron(0 0 1 ? * FRI *)"
    Type: String
  pPatchMgmtMaintWindow3Duration:
    ConstraintDescription: Must be a number between 1 and 24.
    Description: Patch Management Maintenance Window 3 Duration (hrs)
    Default: 6
    Type: Number
    MinValue: 1
    MaxValue: 24
  pPatchMgmtMaintWindow3Cutoff:
    Description: Stop initiating tasks before maintenance window ends (hrs)
    Default: 1
    Type: Number
    MinValue: 0
    MaxValue: 23
  pPatchMgmtMaintWindow3TZ:
    Description: Patch Management Maintenance Window 3 Timezone
    Default: America/New_York
    AllowedValues:
      - America/New_York
      - America/Chicago
      - America/Los_Angeles
      - America/Denver
      - America/Phoenix
      - America/Edmonton
      - America/Halifax
      - America/Whitehorse
      - America/Yellowknife
      - America/Nipigon
      - America/Indiana/Indianapolis
      - America/Indiana/Knox
      - America/Indiana/Muncie
      - America/Indiana/Portage
      - America/Indiana/Vincennes
      - America/Indiana/Winamac
      - America/Indiana/Terre_Haute
      - America/Monterey
      - America/Louisville
      - America/Montreal
      - America/Nassau
      - America/New_York
      - America/Detroit
      - America/Tijuana
      - America/Toronto
      - America/Vancouver
      - America/Edmonton
      - America/Yellowknife
      - America/Nipigon
      - America/Indiana/Indianapolis
      - America/Indiana/Knox
      - America/Indiana/Muncie
      - America/Indiana/Portage
      - America/Indiana/Vincennes
      - America/Indiana/Winamac
      - America/Indiana/Terre_Haute
      - America/Monterey
      - America/Louisville
      - America/Montreal
      - America/Nassau
      - America/New_York
      - America/Detroit
      - America/Tijuana
      - America/Toronto
      - America/Vancouver
      - Europe/Amsterdam
      - Europe/Belgrade
      - Europe/Berlin
      - Europe/Brussels
      - Europe/Dublin
      - Europe/Gibraltar
      - Europe/Helsinki
      - Europe/Kyiv
      - Europe/Lisbon
      - Europe/London
      - Europe/Luxembourg
      - Europe/Madrid
      - Europe/Malta
      - Europe/Monaco
      - Europe/Moscow
      - Europe/Oslo
      - Europe/Paris
      - Europe/Podgorica
      - Europe/Prague
      - Europe/Rome
      - Europe/Sarajevo
      - Europe/Skopje
      - Europe/Stockholm
      - Europe/Tirane
      - Europe/Tromsø
      - Europe/Vatican
      - Europe/Vienna
      - Europe/Warsaw
      - Europe/Zagreb
      - Europe/Zurich
    Type: String
  pPatchMgmtTask3Name:
    AllowedPattern: '^[a-zA-Z0-9-_\s]{3,128}$'
    ConstraintDescription: Maintenance Window Task Name can include numbers, lowercase letters, uppercase letters, and hyphens (-). It cannot start or end with a hyphen (-).
    Description: Patch Management Task 3 Name
    Type: String
    Default: Linux_Scan
  pPatchMgmtTask3Desc:
    AllowedPattern: '^[a-zA-Z0-9-_\s]{3,128}$'
    ConstraintDescription: Maintenance Window Task Description can include numbers, lowercase letters, uppercase letters, and hyphens (-). It cannot start or end with a hyphen (-).
    Description: Patch Management Task 3 Description
    Default: Task to scan Windows Instances
    Type: String
  pPatchMgmtTask3Operation:
    AllowedValues: ["Scan", "Install"]
    ConstraintDescription: Maintenance Window Task Operation can be either Scan or Install.
    Description: Patch Management Task can be configured to either scan for patches or install patches.
    Default: Scan
    Type: String
  pPatchMgmtTask3RebootOption:
    AllowedValues: ["RebootIfNeeded", "NoReboot"]
    ConstraintDescription: Maintenance Window Task Reboot Option can be either Reboot If Needed or No Reboot.
    Description: Patch Management Task can be configured to either Reboot or Not Reboot.
    Default: RebootIfNeeded
    Type: String
  pPatchMgmtTask3RunCmd:
    AllowedValues: [AWS-RunPatchBaseline]
    Description: Patch Management Task 3 Run Command
    Default: AWS-RunPatchBaseline
    Type: String
  pPatchMgmtTarget3Name:
    AllowedPattern: '^[a-zA-Z0-9-_\s]{3,128}$'
    ConstraintDescription: Maintenance Window Target Name can include numbers, lowercase letters, uppercase letters, and hyphens (-). It cannot start or end with a hyphen (-).
    Description: Patch Management Target 3 Name
    Default: AWS_RunPatchBaseline
    Type: String
  pPatchMgmtTarget3Desc:
    AllowedPattern: '^[a-zA-Z0-9-_\s]{3,128}$'
    ConstraintDescription: Maintenance Window Target Desription can include numbers, lowercase letters, uppercase letters, and hyphens (-). It cannot start or end with a hyphen (-).
    Description: Patch Management Target 3 Description
    Default: Targets to run the command to scan for Linux updates
    Type: String
  pPatchMgmtTarget3Value1:
    AllowedValues: [Linux]
    Description: Patch Management Tag Value of Target group 3
    Default: Linux
    Type: String

  pCommonPrerequisitesRegionsOnly:
    AllowedValues: ["true", "false"]
    Default: "true"
    Description: Only enable in the customer regions specified in Common Prerequisites solution
    Type: String
  pRecorderName:
    AllowedPattern: '^([\w.-]{1,900})$|^(\/[\w.-]{1,900})*[\w.-]{1,900}$'
    ConstraintDescription: Must be alphanumeric or special characters [., _, -]. In addition, the slash character ( / ) used to delineate hierarchies in parameter names.
    Default: sra-ConfigRecorder
    Description: Config recorder name
    Type: String
  pDeliveryChannelName:
    AllowedPattern: '^([\w.-]{1,900})$|^(\/[\w.-]{1,900})*[\w.-]{1,900}$'
    ConstraintDescription: Must be alphanumeric or special characters [., _, -]. In addition, the slash character ( / ) used to delineate hierarchies in parameter names.
    Default: sra-config-s3-delivery
    Description: Config delivery channel name
    Type: String
  pConfigOrgDeliveryBucketPrefix:
    AllowedPattern: "^$|^[0-9a-zA-Z]+([0-9a-zA-Z-]*[0-9a-zA-Z])*$"
    ConstraintDescription: S3 bucket name can include numbers, lowercase letters, uppercase letters, and hyphens (-). It cannot start or end with a hyphen (-).
    Default: sra-config-org-delivery
    Description: Config Delivery S3 bucket prefix. The account and region will get added to the end. e.g. sra-config-delivery-123456789012-us-east-1
    Type: String
  pConfigOrgDeliveryKeyAlias:
    Default: sra-config-org-delivery-key
    Description: Config Delivery KMS Key Alias
    Type: String
  pConfigTopicName:
    AllowedPattern: '^[\w+=,.@-]{1,64}$'
    Default: sra-ConfigNotifications
    Description: Configuration Notification SNS Topic in Audit Account that AWS Config delivers notifications to.
    Type: String
  pSubscribeToConfigurationTopic:
    AllowedValues: [true, false]
    Default: false
    Description: Indicates whether ConfigurationEmail will be subscribed to the Configuration Notification SNS Topic.
    Type: String
  pConfigurationEmail:
    AllowedPattern: '^$|^([a-zA-Z0-9_.+-]+@[a-zA-Z0-9-]+\.[a-zA-Z0-9-.]+)$'
    ConstraintDescription: Email Validation as per RFC2822 standards.
    Description: Email for receiving all AWS configuration events
    Default: ""
    Type: "String"
  pConfigOrgSnsKeyAlias:
    Default: sra-config-org-sns-key
    Description: Config SNS KMS Key Alias
    Type: String
  pAggregatorName:
    AllowedPattern: '^[\w\-]+'
    ConstraintDescription: Max 256 alphanumeric characters.
    Default: sra-config-aggregator-org
    MaxLength: 256
    MinLength: 1
    Type: String
  pAggregatorRoleName:
    AllowedPattern: '^[\w+=,.@-]{1,64}$'
    ConstraintDescription: Max 64 alphanumeric characters. Also special characters supported [+, =, ., @, -].
    Default: sra-config-aggregator-org
    Type: String
  pRegisterDelegatedAdminAccount:
    AllowedValues: ["Yes", "No"]
    Default: "Yes"
    Description: Register a delegated administrator account using the Common Register Delegated Administrator solution.
    Type: String
  pConfigEnabledRegions:
    AllowedPattern: "^$|^([a-z0-9-]{1,64})$|^(([a-z0-9-]{1,64},)*[a-z0-9-]{1,64})$"
    ConstraintDescription:
      Only lowercase letters, numbers, and hyphens ('-') allowed. (e.g. us-east-1) Additional AWS regions can be provided, separated by commas. (e.g.
      us-east-1,ap-southeast-2)
    Default: ""
    Description:
      (Optional) Enabled regions (AWS regions, separated by commas). If 'Common Prerequisites Regions Only' parameter is set to 'false', then this
      parameter becomes required.
    Type: String

Rules:
  BillingContactValidation:
    RuleCondition: !And
      - !Equals [!Ref pDeployAccountAlternateContactsSolution, "Yes"]
      - !Equals [!Ref pBillingContactAction, "add"]
    Assertions:
      - Assert: !And
          - !Not [!Equals [!Ref pBillingName, ""]]
          - !Not [!Equals [!Ref pBillingTitle, ""]]
          - !Not [!Equals [!Ref pBillingEmail, ""]]
          - !Not [!Equals [!Ref pBillingPhone, ""]]
        AssertDescription:
          "'Billing Full Name', 'Billing Title', 'Billing Email' and 'Billing Phone' parameters are required if the 'Billing Alternate Contact Action'
          parameter is set to 'add'."
  DeployConfigConformancePackSolutionValidation:
    RuleCondition: !Equals [!Ref pDeployConfigConformancePackSolution, "Yes"]
    Assertions:
      - Assert: !Or
          - !Equals [!Ref pDeployConfigManagementSolution, "Yes"]
          - !Equals [!Ref pDeployConfigManagementSolution, "Already Deployed"]
          - !Equals [!Ref pDeployConfigSolution, "Yes"]
        AssertDescription:
          "'Deploy the AWS Config Management Solution' parameter must be set to 'Yes' or 'Already Deployed', if the 'Deploy the AWS Config Conformance
          Pack Solution' parameter is set to 'Yes'."
  DeploySecurityHubSolutionValidation:
    RuleCondition: !Equals [!Ref pDeploySecurityHubSolution, "Yes"]
    Assertions:
      - Assert: !Or
          - !Equals [!Ref pDeployConfigManagementSolution, "Yes"]
          - !Equals [!Ref pDeployConfigManagementSolution, "Already Deployed"]
          - !Equals [!Ref pDeployConfigSolution, "Yes"]
        AssertDescription:
          "'Deploy the AWS Config Management Solution' parameter must be set to 'Yes' or 'Already Deployed', if the 'Deploy the Security Hub Solution'
          parameter is set to 'Yes'."
  OperationsContactValidation:
    RuleCondition: !And
      - !Equals [!Ref pDeployAccountAlternateContactsSolution, "Yes"]
      - !Equals [!Ref pOperationsContactAction, "add"]
    Assertions:
      - Assert: !And
          - !Not [!Equals [!Ref pOperationsName, ""]]
          - !Not [!Equals [!Ref pOperationsTitle, ""]]
          - !Not [!Equals [!Ref pOperationsEmail, ""]]
          - !Not [!Equals [!Ref pOperationsPhone, ""]]
        AssertDescription:
          "'Operations Full Name', 'Operations Title', 'Operations Email' and 'Operations Phone' parameters are required if the 'Operations Alternate
          Contact Action' parameter is set to 'add'."
  SecurityContactValidation:
    RuleCondition: !And
      - !Equals [!Ref pDeployAccountAlternateContactsSolution, "Yes"]
      - !Equals [!Ref pSecurityContactAction, "add"]
    Assertions:
      - Assert: !And
          - !Not [!Equals [!Ref pSecurityName, ""]]
          - !Not [!Equals [!Ref pSecurityTitle, ""]]
          - !Not [!Equals [!Ref pSecurityEmail, ""]]
          - !Not [!Equals [!Ref pSecurityPhone, ""]]
        AssertDescription:
          "'Security Full Name', 'Security Title', 'Security Email' and 'Security Phone' parameters are required if the 'Security Alternate Contact
          Action' parameter is set to 'add'."
  EnabledRegionValidation:
    RuleCondition: !Equals [!Ref pCommonPrerequisitesRegionsOnly, "false"]
    Assertions:
      - Assert: !Not [!Equals [!Ref pConfigEnabledRegions, ""]]
        AssertDescription: "'Enabled Regions' parameter has to have a value if 'Common Prerequisites Regions Only' parameter is set to 'false'."
  ResourceTypesValidation:
    RuleCondition: !Equals [!Ref pAllSupported, "false"]
    Assertions:
      - AssertDescription: "'Resource Types' parameter is required if 'All Supported' parameter is set to 'false'."
        Assert: !Not [!Equals [!Ref pResourceTypes, ""]]

Conditions:
  cUsingKmsKey: !Not [!Equals [!Ref pLambdaLogGroupKmsKey, ""]]
  cUseGraviton: !Or
    - !Equals [!Ref "AWS::Region", ap-northeast-1]
    - !Equals [!Ref "AWS::Region", ap-south-1]
    - !Equals [!Ref "AWS::Region", ap-southeast-1]
    - !Equals [!Ref "AWS::Region", ap-southeast-2]
    - !Equals [!Ref "AWS::Region", eu-central-1]
    - !Equals [!Ref "AWS::Region", eu-west-1]
    - !Equals [!Ref "AWS::Region", eu-west-2]
    - !Equals [!Ref "AWS::Region", us-east-1]
    - !Equals [!Ref "AWS::Region", us-east-2]
    - !Equals [!Ref "AWS::Region", us-west-2]

  cDeployInspectorSolution: !Equals [!Ref pDeployInspectorSolution, "Yes"]

  cCreateLambdaLogGroup: !Equals [!Ref pCreateLambdaLogGroup, "Yes"]
  cDeployAccountAlternateContactsSolution:
    !Equals [!Ref pDeployAccountAlternateContactsSolution, "Yes"]
  cDeployCloudTrailSolution: !Equals [!Ref pDeployCloudTrailSolution, "Yes"]
  cDeployConfigSolution: !Equals [!Ref pDeployConfigSolution, "Yes"]
  cDeployConfigManagementSolution:
    !Equals [!Ref pDeployConfigManagementSolution, "Yes"]
  cDeployConfigManagementSolutionAlreadyDeployed:
    !Equals [!Ref pDeployConfigManagementSolution, "Already Deployed"]
  cDeployConfigConformancePackSolution: !And
    - !Or
      - !Condition cDeployConfigManagementSolution
      - !Condition cDeployConfigManagementSolutionAlreadyDeployed
      - !Condition cDeployConfigSolution
    - !Equals [!Ref pDeployConfigConformancePackSolution, "Yes"]
  cDeployDetectiveSolution: !Equals [!Ref pDeployDetectiveSolution, "Yes"]
  cDeployEC2DefaultEBSEncryptionSolution:
    !Equals [!Ref pDeployEC2DefaultEBSEncryptionSolution, "Yes"]
  cDeployFirewallManagerSolution:
    !Equals [!Ref pDeployFirewallManagerSolution, "Yes"]
  cDeployGuardDutySolution: !Equals [!Ref pDeployGuardDutySolution, "Yes"]
  cDeployIAMAccessAnalyzerSolution:
    !Equals [!Ref pDeployIAMAccessAnalyzerSolution, "Yes"]
  cDeployIAMPasswordPolicySolution:
    !Equals [!Ref pDeployIAMPasswordPolicySolution, "Yes"]
  cDeployMacieSolution: !Equals [!Ref pDeployMacieSolution, "Yes"]
  cDeployS3BlockAccountPublicAccessSolution:
    !Equals [!Ref pDeployS3BlockAccountPublicAccessSolution, "Yes"]
  cDeploySecurityHubSolution: !And
    - !Or
      - !Condition cDeployConfigManagementSolution
      - !Condition cDeployConfigManagementSolutionAlreadyDeployed
    - !Equals [!Ref pDeploySecurityHubSolution, "Yes"]
  cDeployShieldSolution: !Equals [!Ref pDeployShieldSolution, "Yes"]
  cDisableGuardDuty: !Equals [!Ref pDisableGuardDuty, "Yes"]
  cDisableMacie: !Equals [!Ref pDisableMacie, "Yes"]
  cDisableSecurityHub: !Equals [!Ref pDisableSecurityHub, "Yes"]

  cDeployPatchMgrSolution: !Equals [!Ref pDeployPatchMgrSolution, "Yes"]

Resources:
  rCodeBuildProject:
    Type: AWS::CodeBuild::Project
    Properties:
      Name: !Sub "${pCodeBuildProjectName}"
      Artifacts:
        Type: NO_ARTIFACTS
      Description: "Codebuild project to get SRA code from github"
      Environment:
        ComputeType: BUILD_GENERAL1_SMALL
        EnvironmentVariables:
          - Name: AWS_DEFAULT_REGION
            Value: !Ref AWS::Region
          - Name: AWS_ACCOUNT_ID
            Value: !Ref "AWS::AccountId"
          - Name: SRA_REPO_URL
            Value: !Ref pRepoURL
          - Name: SRA_REPO_BRANCH_NAME
            Value: !Ref pRepoBranch
          - Name: SRA_STAGING_S3_BUCKET_STACK_NAME
            Value: !Ref pSRAStagingS3BucketStackName
        Image: "aws/codebuild/standard:5.0"
        PrivilegedMode: true
        Type: "LINUX_CONTAINER"
      ServiceRole: !GetAtt rCodeBuildRole.Arn
      TimeoutInMinutes: 120
      Source:
        Type: NO_SOURCE
        BuildSpec: !Sub |
          version: 0.2
          phases:
            pre_build:
              commands:
                - echo Build started on `date`...
            build:
              commands:
                - echo Build started on `date` in ${AWS::Region} region
                - echo Cloning SRA code repository from $SRA_REPO_URL...
                - git clone $SRA_REPO_URL
                - echo Listing current directory...
                - ls
                - cd aws-security-reference-architecture-examples
                - git checkout $SRA_REPO_BRANCH_NAME
                - echo Showing current caller identity...
                - aws sts get-caller-identity
                - echo Deploying SRA staging bucket cloudformation template...
                - aws cloudformation deploy --template-file ./aws_sra_examples/solutions/common/common_prerequisites/templates/sra-common-prerequisites-staging-s3-bucket.yaml --stack-name $SRA_STAGING_S3_BUCKET_STACK_NAME --capabilities CAPABILITY_NAMED_IAM
                - echo Staging SRA solutions...
                - ./aws_sra_examples/utils/packaging_scripts/stage_solution.sh
            post_build:
              commands:
                - echo Build completed on `date`

  rCommonPrerequisitesManagementAccountParametersStack:
    Type: AWS::CloudFormation::Stack
    DependsOn: rStartCodeBuildProjectCustomResource
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      TemplateURL: !Sub
        - https://${SRAStagingS3BucketName}.s3.${AWS::Region}.${AWS::URLSuffix}/${pSRASolutionName}/templates/sra-common-prerequisites-management-account-parameters.yaml
        - SRAStagingS3BucketName: !Sub ${pSRAStagingS3BucketNamePrefix}-${AWS::AccountId}-${AWS::Region}
      Tags:
        - Key: sra-solution
          Value: !Ref pSRASolutionName
      Parameters:
        pControlTower: !Ref pControlTower
        pGovernedRegions: !Ref pGovernedRegions
        pSecurityAccountId: !Ref pSecurityAccountId
        pLogArchiveAccountId: !Ref pLogArchiveAccountId

  rCommonPrerequisitesMainSsm:
    Type: AWS::CloudFormation::Stack
    DependsOn: rCommonPrerequisitesManagementAccountParametersStack
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      TemplateURL: !Sub
        - https://${SRAStagingS3BucketName}.s3.${AWS::Region}.${AWS::URLSuffix}/${pSRASolutionName}/templates/sra-common-prerequisites-main-ssm.yaml
        - SRAStagingS3BucketName: !Sub ${pSRAStagingS3BucketNamePrefix}-${AWS::AccountId}-${AWS::Region}
      Tags:
        - Key: sra-solution
          Value: !Ref pSRASolutionName
      Parameters:
        pCreateAWSControlTowerExecutionRole: !Ref pCreateAWSControlTowerExecutionRole
        pControlTower: !Ref pControlTower

  rCodeBuildRole:
    Type: AWS::IAM::Role
    Metadata:
      cfn_nag:
        rules_to_suppress:
          - id: W11
            reason: Allow * in resource when required
          - id: W28
            reason: The role name is defined to identify automation resources
    Properties:
      RoleName: !Sub "${pCodeBuildRoleName}"
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - codebuild.amazonaws.com
            Action:
              - "sts:AssumeRole"
      Policies:
        - PolicyName: "logs-access"
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource:
                  - !Sub "arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/codebuild/*"
        - PolicyName: "cloudformation-changeset-access"
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - cloudformation:CreateChangeSet
                  - cloudformation:DescribeChangeSet
                  - cloudformation:ExecuteChangeSet
                Resource:
                  - !Sub "arn:${AWS::Partition}:cloudformation:${AWS::Region}:${AWS::AccountId}:stack/*"
                  - !Sub "arn:${AWS::Partition}:cloudformation:${AWS::Region}:${AWS::AccountId}:changeSet/*"
        - PolicyName: "cloudformation-describe-access"
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - cloudformation:DescribeStacks
                Resource: "*"
        - PolicyName: "IAM-Access-Policy"
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - iam:GetRole
                  - iam:PassRole
                  - iam:GetRolePolicy
                  - iam:PutRolePolicy
                  - iam:CreateRole
                  - iam:DeleteRolePolicy
                  - iam:DeleteRole
                  - iam:TagRole
                Resource:
                  - !Sub "arn:${AWS::Partition}:iam::${AWS::AccountId}:role/sra*"
        - PolicyName: "lambda-access"
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - lambda:GetFunction
                  - lambda:GetFunctionCodeSigningConfig
                  - lambda:GetRuntimeManagementConfig
                  - lambda:CreateFunction
                  - lambda:DeleteFunction
                  - lambda:TagResource
                  - lambda:InvokeFunction
                Resource:
                  - !Sub "arn:${AWS::Partition}:lambda:${AWS::Region}:${AWS::AccountId}:function:sra*"
        - PolicyName: "s3-staging-bucket-access"
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: "Allow"
                Action:
                  - s3:GetObject
                  - s3:PutObject
                  - s3:ListBucket
                  - s3:GetBucketAcl
                  - s3:GetBucketPolicy
                  - s3:DeleteBucket
                Resource:
                  - !Sub "arn:${AWS::Partition}:s3:::${pSRAStagingS3BucketNamePrefix}-${AWS::AccountId}-${AWS::Region}"
                  - !Sub "arn:${AWS::Partition}:s3:::${pSRAStagingS3BucketNamePrefix}-${AWS::AccountId}-${AWS::Region}/*"
        - PolicyName: "s3-create-bucket-access"
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: "Allow"
                Action:
                  - s3:PutBucketPolicy
                  - s3:PutBucketTagging
                  - s3:PutBucketPublicAccessBlock
                  - s3:GetEncryptionConfiguration
                  - s3:PutEncryptionConfiguration
                  - s3:PutBucketOwnershipControls
                  - s3:CreateBucket
                  - s3:PutBucketAcl
                  - s3:PutBucketObjectLockConfiguration
                  - s3:PutBucketVersioning
                  - s3:SetBucketEncryption
                  - s3:PutBucketEncryption
                Resource:
                  - "arn:aws:s3:::*"
        - PolicyName: "ssm-access"
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: "Allow"
                Action:
                  - ssm:GetParameter
                  - ssm:GetParameters
                  - ssm:PutParameter
                  - ssm:AddTagsToResource
                Resource:
                  - !Sub "arn:${AWS::Partition}:ssm:${AWS::Region}:${AWS::AccountId}:parameter/sra*"

  rStartCodeBuildProjectCustomResource:
    DependsOn: rCodeBuildProject
    Type: Custom::LambdaCustomResource
    Version: "1.0"
    Properties:
      ServiceToken: !GetAtt rStartCodeBuildProjectLambdaFunction.Arn

  rStartCodeBuildProjectLambdaFunction:
    Metadata:
      cfn_nag:
        rules_to_suppress:
          - id: W58
            reason: Lambda role provides access to CloudWatch Logs
          - id: W89
            reason: Lambda does not need to communicate with VPC resources.
          - id: W92
            reason: Lambda does not need reserved concurrent executions.
      checkov:
        skip:
          - id: CKV_AWS_115
            comment: Lambda does not need reserved concurrent executions.
          - id: CKV_AWS_116
            comment: DLQ not needed, as Lambda function only triggered by CloudFormation events.
          - id: CKV_AWS_117
            comment: Lambda does not need to communicate with VPC resources.
          - id: CKV_AWS_173
            comment: Environment variables are not sensitive.
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Ref pCodeBuildProjectLambdaFunctionName
      Description: Start SRA codebuild project
      Architectures: !If
        - cUseGraviton
        - [arm64]
        - !Ref AWS::NoValue
      Handler: index.lambda_handler
      Role: !GetAtt rStartCodeBuildProjectLambdaRole.Arn
      Runtime: python3.9
      Timeout: 900
      Environment:
        Variables:
          LOG_LEVEL: !Ref pLambdaLogLevel
          CODE_BUILD_PROJECT_NAME: !Ref pCodeBuildProjectName
          SRA_STAGING_S3_BUCKET_NAME: !Sub ${pSRAStagingS3BucketNamePrefix}-${AWS::AccountId}-${AWS::Region}
          SRA_STAGING_S3_BUCKET_STACK_NAME: !Ref pSRAStagingS3BucketStackName
      Tags:
        - Key: !Ref pSRASolutionTagKey
          Value: !Ref pSRASolutionName
      Code:
        ZipFile: |
          # type: ignore
          """Custom Resource to start codebuild project.

          Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.
          SPDX-License-Identifier: MIT-0
          """
          import logging
          import os

          import boto3
          import cfnresponse
          import time
          from botocore.exceptions import ClientError

          LOGGER = logging.getLogger(__name__)
          log_level: str = os.environ.get("LOG_LEVEL", "INFO")
          LOGGER.setLevel(log_level)
          CODE_BUILD_PROJECT_NAME: str = os.environ.get("CODE_BUILD_PROJECT_NAME")
          SRA_STAGING_S3_BUCKET_NAME: str = os.environ.get("SRA_STAGING_S3_BUCKET_NAME")
          SRA_STAGING_S3_BUCKET_STACK_NAME: str = os.environ.get("SRA_STAGING_S3_BUCKET_STACK_NAME")


          def start_build():
              """Start build job.

              Returns:
                  Response data for custom resource
              """
              management_account_session = boto3.Session()
              codebuild_client = management_account_session.client("codebuild")
              response = codebuild_client.start_build(projectName=CODE_BUILD_PROJECT_NAME)
              LOGGER.info({"API_Call": "codebuild:StartBuild", "API_Response": response})
              buildId = response["build"]["id"]
              return wait_for_build([buildId], codebuild_client)


          def wait_for_build(BuildId, client):
              buildWaitStatus = "FAILURE_WAIT_TIMEOUT"
              counter = 0
              while counter < 45:
                  time.sleep(10)
                  counter = counter + 1
                  buildStatus = get_build_status(BuildId, client)
                  if buildStatus == "SUCCEEDED":
                      buildWaitStatus = "SUCCESS"
                      break
                  elif buildStatus == "FAILED" or buildStatus == "FAULT" or buildStatus == "STOPPED" or buildStatus == "TIMED_OUT":
                      buildWaitStatus = "BUILD " + buildStatus + " (check codebuild project cloudwatch log group for details)"
                      break
              return buildWaitStatus


          def get_build_status(buildId, client):
              build = client.batch_get_builds(ids=buildId)
              return build["builds"][0]["buildStatus"]


          def create_event(event, context):
              try:
                  data = {"data": start_build()}
                  if data["data"] == "SUCCESS":
                      cfnresponse.send(event, context, cfnresponse.SUCCESS, data, "CustomResourcePhysicalID")
                  else:
                      reason = f"See the details in CloudWatch Log Stream: '{context.log_group_name} and CloudFormation Events'"
                      cfnresponse.send(event, context, cfnresponse.FAILED, data, "CustomResourcePhysicalID")
              except Exception:
                  LOGGER.exception("Unexpected!")
                  reason = f"See the details in CloudWatch Log Stream: '{context.log_group_name}'"
                  cfnresponse.send(event, context, cfnresponse.FAILED, {}, "CustomResourcePhysicalID", reason=reason)
              return "CustomResourcePhysicalID"


          def delete_event(event, context):
              cfn_client = boto3.client("cloudformation")
              s3_client = boto3.resource("s3")
              staging_bucket = s3_client.Bucket(SRA_STAGING_S3_BUCKET_NAME)
              try:
                  bucket_versioning = staging_bucket.Versioning()
                  if bucket_versioning.status == "Enabled":
                      LOGGER.info("versioning enabled; deleting object versions")
                      delete_version_response = staging_bucket.object_versions.delete()
                      LOGGER.info("see next message for delete response")
                      LOGGER.info(delete_version_response)
                      LOGGER.info("suspending versioning...")
                      bucket_versioning.suspend()
                  LOGGER.info("deleting objects")
                  delete_object_response = staging_bucket.objects.all().delete()
                  LOGGER.info("see next message for delete object response")
                  LOGGER.info(delete_object_response)
              except ClientError as e:
                  LOGGER.info(f"Delete objects error: {e}")
                  reason = f"See the details in CloudWatch Log Stream: '{context.log_group_name}'"
                  cfnresponse.send(event, context, cfnresponse.FAILED, {}, "CustomResourcePhysicalID", reason=reason)
              cfn_response = cfn_client.delete_stack(StackName=SRA_STAGING_S3_BUCKET_STACK_NAME)
              LOGGER.info(cfn_response)
              waiter = cfn_client.get_waiter("stack_delete_complete")
              waiter.wait(StackName=SRA_STAGING_S3_BUCKET_STACK_NAME, WaiterConfig={"Delay": 15, "MaxAttempts": 120})
              LOGGER.info(SRA_STAGING_S3_BUCKET_STACK_NAME + " stack deleted")
              cfnresponse.send(event, context, cfnresponse.SUCCESS, {"delete_operation": f"succeeded deleting {SRA_STAGING_S3_BUCKET_STACK_NAME}"}, "CustomResourcePhysicalID")


          def lambda_handler(event, context):
              LOGGER.info(event)
              if event["RequestType"] == "Create":
                  LOGGER.info("CREATE EVENT!!")
                  create_event(event, context)
              if event["RequestType"] == "Update":
                  LOGGER.info("UPDATE EVENT!!")

              if event["RequestType"] == "Delete":
                  LOGGER.info("DELETE EVENT!!")
                  delete_event(event, context)

  rStartCodeBuildProjectLambdaLogGroup:
    DeletionPolicy: Retain
    Type: AWS::Logs::LogGroup
    UpdateReplacePolicy: Retain
    Properties:
      LogGroupName: !Sub /aws/lambda/${pCodeBuildProjectLambdaFunctionName}
      KmsKeyId: !If
        - cUsingKmsKey
        - !Ref pLambdaLogGroupKmsKey
        - !Ref AWS::NoValue
      RetentionInDays: !Ref pLambdaLogGroupRetention

  rStartCodeBuildProjectLambdaRole:
    Type: AWS::IAM::Role
    Metadata:
      cfn_nag:
        rules_to_suppress:
          #       - id: W11
          #         reason: Allow * in resource when required
          - id: W28
            reason: The role name is defined to identify automation resources
    Properties:
      RoleName: !Ref pCodeBuildProjectLambdaRoleName
      Description: !Sub Role for '${pCodeBuildProjectLambdaRoleName}' Lambda function
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Action: sts:AssumeRole
            Principal:
              Service:
                - lambda.amazonaws.com
      Tags:
        - Key: !Ref pSRASolutionTagKey
          Value: !Ref pSRASolutionName
      Policies:
        - PolicyName: codebuild-access
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Sid: codebuildStartBuild
                Effect: Allow
                Action:
                  - codebuild:StartBuild
                  - codebuild:BatchGetBuilds
                Resource: !GetAtt rCodeBuildProject.Arn
        - PolicyName: CloudWatchLogGroup-access
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Sid: CloudWatchLogs
                Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: !Sub arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/lambda/${pCodeBuildProjectLambdaFunctionName}:log-stream:*
        - PolicyName: "s3-staging-bucket-access"
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: "Allow"
                Action:
                  - s3:GetObject
                  - s3:PutObject
                  - s3:ListBucket
                  - s3:GetBucketAcl
                  - s3:GetBucketPolicy
                  - s3:GetObjectAcl
                  - s3:PutObjectAcl
                  - s3:DeleteBucket
                  - s3:DeleteObject
                  - s3:DeleteObjectVersion
                  - s3:GetBucketVersioning
                  - s3:DeleteBucketPolicy
                  - s3:ListBucketVersions
                  - s3:PutBucketVersioning
                Resource:
                  - !Sub "arn:${AWS::Partition}:s3:::${pSRAStagingS3BucketNamePrefix}-${AWS::AccountId}-${AWS::Region}"
                  - !Sub "arn:${AWS::Partition}:s3:::${pSRAStagingS3BucketNamePrefix}-${AWS::AccountId}-${AWS::Region}/*"
        - PolicyName: "lambda-access"
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - lambda:DeleteFunction
                  - lambda:InvokeFunction
                Resource:
                  - !Sub "arn:${AWS::Partition}:lambda:${AWS::Region}:${AWS::AccountId}:function:sra*"
        - PolicyName: "cloudformation-stack-access"
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - cloudformation:DeleteStack
                  - cloudformation:DescribeStacks
                Resource:
                  - !Sub "arn:${AWS::Partition}:cloudformation:${AWS::Region}:${AWS::AccountId}:stack/sra*"
        - PolicyName: "IAM-access"
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - iam:DeleteRole
                  - iam:DeleteRolePolicy
                Resource:
                  - !Sub "arn:${AWS::Partition}:iam::${AWS::AccountId}:role/sra*"

  rAccountAlternateContactsSolutionStack:
    Type: AWS::CloudFormation::Stack
    DependsOn: rCommonPrerequisitesMainSsm
    Condition: cDeployAccountAlternateContactsSolution
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      TemplateURL: !Sub https://${pSRAStagingS3BucketNamePrefix}-${AWS::AccountId}-${AWS::Region}.s3.${AWS::Region}.${AWS::URLSuffix}/sra-account-alternate-contacts/templates/sra-account-alternate-contacts-main-ssm.yaml
      Parameters:
        pBillingContactAction: !Ref pBillingContactAction
        pBillingEmail: !Ref pBillingEmail
        pBillingName: !Ref pBillingName
        pBillingPhone: !Ref pBillingPhone
        pBillingTitle: !Ref pBillingTitle
        pComplianceFrequency: !Ref pComplianceFrequency
        pCreateLambdaLogGroup: !If [cCreateLambdaLogGroup, true, false]
        pExcludeAlternateContactAccountTags: !Ref pExcludeAlternateContactAccountTags
        pLambdaLogGroupKmsKey: !Ref pLambdaLogGroupKmsKey
        pLambdaLogGroupRetention: !Ref pLambdaLogGroupRetention
        pLambdaLogLevel: !Ref pLambdaLogLevel
        pOperationsContactAction: !Ref pOperationsContactAction
        pOperationsEmail: !Ref pOperationsEmail
        pOperationsName: !Ref pOperationsName
        pOperationsPhone: !Ref pOperationsPhone
        pOperationsTitle: !Ref pOperationsTitle
        pSecurityContactAction: !Ref pSecurityContactAction
        pSecurityEmail: !Ref pSecurityEmail
        pSecurityName: !Ref pSecurityName
        pSecurityPhone: !Ref pSecurityPhone
        pSecurityTitle: !Ref pSecurityTitle
        pSRAAlarmEmail: !Ref pSRAAlarmEmail

  rCloudTrailSolutionStack:
    Type: AWS::CloudFormation::Stack
    DependsOn: rCommonPrerequisitesMainSsm
    Condition: cDeployCloudTrailSolution
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      TemplateURL: !Sub https://${pSRAStagingS3BucketNamePrefix}-${AWS::AccountId}-${AWS::Region}.s3.${AWS::Region}.${AWS::URLSuffix}/sra-cloudtrail-org/templates/sra-cloudtrail-org-main-ssm.yaml
      Parameters:
        pBucketNamePrefix: !Ref pBucketNamePrefix
        pCloudTrailLogGroupKmsKey: !Ref pCloudTrailLogGroupKmsKey
        pCloudTrailLogGroupRetention: !Ref pCloudTrailLogGroupRetention
        pCloudTrailName: !Ref pCloudTrailName
        pCreateCloudTrailLogGroup: !Ref pCreateCloudTrailLogGroup
        pCreateLambdaLogGroup: !If [cCreateLambdaLogGroup, true, false]
        pEnableDataEventsOnly: !Ref pEnableDataEventsOnly
        pEnableLambdaDataEvents: !Ref pEnableLambdaDataEvents
        pEnableS3DataEvents: !Ref pEnableS3DataEvents
        pLambdaLogGroupKmsKey: !Ref pLambdaLogGroupKmsKey
        pLambdaLogGroupRetention: !Ref pLambdaLogGroupRetention
        pLambdaLogLevel: !Ref pLambdaLogLevel
        pOrganizationCloudTrailKeyAlias: !Ref pOrganizationCloudTrailKeyAlias

  rConfigManagementSolutionStack:
    Type: AWS::CloudFormation::Stack
    DependsOn: rCommonPrerequisitesMainSsm
    Condition: cDeployConfigManagementSolution
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      TemplateURL: !Sub https://${pSRAStagingS3BucketNamePrefix}-${AWS::AccountId}-${AWS::Region}.s3.${AWS::Region}.${AWS::URLSuffix}/sra-config-management-account/templates/sra-config-management-account-main-ssm.yaml
      Parameters:
        pAllSupported: !Ref pAllSupported
        pCreateLambdaLogGroup: !If [cCreateLambdaLogGroup, true, false]
        pFrequency: !Ref pFrequency
        pIncludeGlobalResourceTypes: !Ref pIncludeGlobalResourceTypes
        pKmsKeyArn: !Ref pKmsKeyArn
        pLambdaLogGroupKmsKey: !Ref pLambdaLogGroupKmsKey
        pLambdaLogGroupRetention: !Ref pLambdaLogGroupRetention
        pLambdaLogLevel: !Ref pLambdaLogLevel
        pResourceTypes: !Ref pResourceTypes

  rConfigConformancePackSolutionStack:
    Type: AWS::CloudFormation::Stack
    DependsOn: rCommonPrerequisitesMainSsm
    Condition: cDeployConfigConformancePackSolution
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      TemplateURL: !Sub https://${pSRAStagingS3BucketNamePrefix}-${AWS::AccountId}-${AWS::Region}.s3.${AWS::Region}.${AWS::URLSuffix}/sra-config-conformance-pack-org/templates/sra-config-conformance-pack-org-main-ssm.yaml
      Parameters:
        pConformancePackName: !Ref pConformancePackName
        pConformancePackTemplateName: !Ref pConformancePackTemplateName
        pDeliveryS3KeyPrefix: !Ref pDeliveryS3KeyPrefix
        pExcludedAccounts: !Ref pConformancePackExcludedAccounts
        pSourceStackName:
          !If [
            cDeployConfigManagementSolution,
            !Ref rConfigManagementSolutionStack,
            "",
          ]

  rDetectiveSolutionStack:
    Type: AWS::CloudFormation::Stack
    DependsOn: rCommonPrerequisitesMainSsm
    Condition: cDeployDetectiveSolution
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      TemplateURL: !Sub https://${pSRAStagingS3BucketNamePrefix}-${AWS::AccountId}-${AWS::Region}.s3.${AWS::Region}.${AWS::URLSuffix}/sra-detective-org/templates/sra-detective-org-main-ssm.yaml
      Parameters:
        pComplianceFrequency: !Ref pComplianceFrequency
        pCreateLambdaLogGroup: !If [cCreateLambdaLogGroup, true, false]
        pDatasourcePackages: !Join
          - ","
          - !Ref pDatasourcePackages
        pGuarddutyEnabledForMoreThan48Hours: !Ref pGuarddutyEnabledForMoreThan48Hours
        pLambdaLogGroupKmsKey: !Ref pLambdaLogGroupKmsKey
        pLambdaLogGroupRetention: !Ref pLambdaLogGroupRetention
        pLambdaLogLevel: !Ref pLambdaLogLevel
        pSRAAlarmEmail: !Ref pSRAAlarmEmail

  rEC2DefaultEBSEncryptionSolutionStack:
    Type: AWS::CloudFormation::Stack
    DependsOn: rCommonPrerequisitesMainSsm
    Condition: cDeployEC2DefaultEBSEncryptionSolution
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      TemplateURL: !Sub https://${pSRAStagingS3BucketNamePrefix}-${AWS::AccountId}-${AWS::Region}.s3.${AWS::Region}.${AWS::URLSuffix}/sra-ec2-default-ebs-encryption/templates/sra-ec2-default-ebs-encryption-main-ssm.yaml
      Parameters:
        pComplianceFrequency: !Ref pComplianceFrequency
        pCreateLambdaLogGroup: !If [cCreateLambdaLogGroup, true, false]
        pExcludeEC2DefaultEBSEncryptionTags: !Ref pExcludeEC2DefaultEBSEncryptionTags
        pLambdaLogGroupKmsKey: !Ref pLambdaLogGroupKmsKey
        pLambdaLogGroupRetention: !Ref pLambdaLogGroupRetention
        pLambdaLogLevel: !Ref pLambdaLogLevel
        pSRAAlarmEmail: !Ref pSRAAlarmEmail

  rFirewallManagerSolutionStack:
    Type: AWS::CloudFormation::Stack
    DependsOn: rCommonPrerequisitesMainSsm
    Condition: cDeployFirewallManagerSolution
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      TemplateURL: !Sub https://${pSRAStagingS3BucketNamePrefix}-${AWS::AccountId}-${AWS::Region}.s3.${AWS::Region}.${AWS::URLSuffix}/sra-firewall-manager-org/templates/sra-firewall-manager-org-main-ssm.yaml
      Parameters:
        pCreateLambdaLogGroup: !If [cCreateLambdaLogGroup, true, false]
        pCreateVpcForSG: !Ref pCreateVpcForSG
        pEnableRemediation: !Ref pEnableRemediation
        pInternalNetCIDR: !Ref pInternalNetCIDR
        pLambdaLogGroupKmsKey: !Ref pLambdaLogGroupKmsKey
        pLambdaLogGroupRetention: !Ref pLambdaLogGroupRetention
        pLambdaLogLevel: !Ref pLambdaLogLevel
        pVPCCidrBlock: !Ref pVPCCidrBlock
        pVpcId: !Ref pVpcId

  rGuardDutySolutionStack:
    Type: AWS::CloudFormation::Stack
    DependsOn: rCommonPrerequisitesMainSsm
    Condition: cDeployGuardDutySolution
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      TemplateURL: !Sub https://${pSRAStagingS3BucketNamePrefix}-${AWS::AccountId}-${AWS::Region}.s3.${AWS::Region}.${AWS::URLSuffix}/sra-guardduty-org/templates/sra-guardduty-org-main-ssm.yaml
      Parameters:
        pAutoEnableS3Logs: !Ref pAutoEnableS3Logs
        pAutoEnableKubernetesAuditLogs: !Ref pAutoEnableKubernetesAuditLogs
        pAutoEnableMalwareProtection: !Ref pAutoEnableMalwareProtection
        pEnableRdsLoginEvents: !Ref pEnableRdsLoginEvents
        pEnableEksRuntimeMonitoring: !Ref pEnableEksRuntimeMonitoring
        pEnableEksAddonManagement: !Ref pEnableEksAddonManagement
        pEnableLambdaNetworkLogs: !Ref pEnableLambdaNetworkLogs
        pCreateLambdaLogGroup: !If [cCreateLambdaLogGroup, true, false]
        pDisableGuardDuty: !If [cDisableGuardDuty, true, false]
        pFindingPublishingFrequency: !Ref pGuardDutyFindingPublishingFrequency
        pGuardDutyOrgDeliveryBucketPrefix: !Ref pGuardDutyOrgDeliveryBucketPrefix
        pGuardDutyOrgDeliveryKeyAlias: !Ref pGuardDutyOrgDeliveryKeyAlias
        pLambdaLogGroupKmsKey: !Ref pLambdaLogGroupKmsKey
        pLambdaLogGroupRetention: !Ref pLambdaLogGroupRetention
        pLambdaLogLevel: !Ref pLambdaLogLevel
        pSRAAlarmEmail: !Ref pSRAAlarmEmail

  rIAMAccessAnalyzerSolutionStack:
    Type: AWS::CloudFormation::Stack
    DependsOn: rCommonPrerequisitesMainSsm
    Condition: cDeployIAMAccessAnalyzerSolution
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      TemplateURL: !Sub https://${pSRAStagingS3BucketNamePrefix}-${AWS::AccountId}-${AWS::Region}.s3.${AWS::Region}.${AWS::URLSuffix}/sra-iam-access-analyzer/templates/sra-iam-access-analyzer-main-ssm.yaml
      Parameters:
        pAccessAnalyzerNamePrefix: !Ref pAccessAnalyzerNamePrefix
        pOrganizationAccessAnalyzerName: !Ref pOrganizationAccessAnalyzerName
        pRegisterDelegatedAdminAccount: !Ref pAccessAnalyzerRegisterDelegatedAdminAccount

  rIAMPasswordPolicySolutionStack:
    Type: AWS::CloudFormation::Stack
    DependsOn: rCommonPrerequisitesMainSsm
    Condition: cDeployIAMPasswordPolicySolution
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      TemplateURL: !Sub https://${pSRAStagingS3BucketNamePrefix}-${AWS::AccountId}-${AWS::Region}.s3.${AWS::Region}.${AWS::URLSuffix}/sra-iam-password-policy/templates/sra-iam-password-policy-main-ssm.yaml
      Parameters:
        pAllowUsersToChangePassword: !Ref pAllowUsersToChangePassword
        pCreateLambdaLogGroup: !If [cCreateLambdaLogGroup, true, false]
        pHardExpiry: !Ref pHardExpiry
        pLambdaLogGroupKmsKey: !Ref pLambdaLogGroupKmsKey
        pLambdaLogGroupRetention: !Ref pLambdaLogGroupRetention
        pLambdaLogLevel: !Ref pLambdaLogLevel
        pMaxPasswordAge: !Ref pMaxPasswordAge
        pMinimumPasswordLength: !Ref pMinimumPasswordLength
        pPasswordReusePrevention: !Ref pPasswordReusePrevention
        pRequireLowercaseCharacters: !Ref pRequireLowercaseCharacters
        pRequireNumbers: !Ref pRequireNumbers
        pRequireSymbols: !Ref pRequireSymbols
        pRequireUppercaseCharacters: !Ref pRequireUppercaseCharacters

  rMacieSolutionStack:
    Type: AWS::CloudFormation::Stack
    DependsOn: rCommonPrerequisitesMainSsm
    Condition: cDeployMacieSolution
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      TemplateURL: !Sub https://${pSRAStagingS3BucketNamePrefix}-${AWS::AccountId}-${AWS::Region}.s3.${AWS::Region}.${AWS::URLSuffix}/sra-macie-org/templates/sra-macie-org-main-ssm.yaml
      Parameters:
        pCreateLambdaLogGroup: !If [cCreateLambdaLogGroup, true, false]
        pDisableMacie: !If [cDisableMacie, true, false]
        pFindingPublishingFrequency: !Ref pMacieFindingPublishingFrequency
        pLambdaLogGroupKmsKey: !Ref pLambdaLogGroupKmsKey
        pLambdaLogGroupRetention: !Ref pLambdaLogGroupRetention
        pLambdaLogLevel: !Ref pLambdaLogLevel
        pMacieOrgDeliveryBucketPrefix: !Ref pMacieOrgDeliveryBucketPrefix
        pMacieOrgDeliveryKeyAlias: !Ref pMacieOrgDeliveryKeyAlias
        pSRAAlarmEmail: !Ref pSRAAlarmEmail

  rS3BlockAccountPublicAccessSolutionStack:
    Type: AWS::CloudFormation::Stack
    DependsOn: rCommonPrerequisitesMainSsm
    Condition: cDeployS3BlockAccountPublicAccessSolution
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      TemplateURL: !Sub https://${pSRAStagingS3BucketNamePrefix}-${AWS::AccountId}-${AWS::Region}.s3.${AWS::Region}.${AWS::URLSuffix}/sra-s3-block-account-public-access/templates/sra-s3-block-account-public-access-main-ssm.yaml
      Parameters:
        pComplianceFrequency: !Ref pComplianceFrequency
        pCreateLambdaLogGroup: !If [cCreateLambdaLogGroup, true, false]
        pEnableBlockPublicAcls: !Ref pEnableBlockPublicAcls
        pEnableBlockPublicPolicy: !Ref pEnableBlockPublicPolicy
        pEnableIgnorePublicAcls: !Ref pEnableIgnorePublicAcls
        pEnableRestrictPublicBuckets: !Ref pEnableRestrictPublicBuckets
        pExcludeS3BlockAccountPublicAccessTags: !Ref pExcludeS3BlockAccountPublicAccessTags
        pLambdaLogGroupKmsKey: !Ref pLambdaLogGroupKmsKey
        pLambdaLogGroupRetention: !Ref pLambdaLogGroupRetention
        pLambdaLogLevel: !Ref pLambdaLogLevel
        pSRAAlarmEmail: !Ref pSRAAlarmEmail

  rSecurityHubSolutionStack:
    Type: AWS::CloudFormation::Stack
    DependsOn: rCommonPrerequisitesMainSsm
    Condition: cDeploySecurityHubSolution
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      TemplateURL: !Sub https://${pSRAStagingS3BucketNamePrefix}-${AWS::AccountId}-${AWS::Region}.s3.${AWS::Region}.${AWS::URLSuffix}/sra-securityhub-org/templates/sra-securityhub-org-main-ssm.yaml
      Parameters:
        pCISStandardVersion: !Ref pCISStandardVersion
        pComplianceFrequency: !Ref pComplianceFrequency
        pCreateLambdaLogGroup: !If [cCreateLambdaLogGroup, true, false]
        pDisableSecurityHub: !If [cDisableSecurityHub, true, false]
        pEnableCISStandard: !Ref pEnableCISStandard
        pEnablePCIStandard: !Ref pEnablePCIStandard
        pEnableSecurityBestPracticesStandard: !Ref pEnableSecurityBestPracticesStandard
        pLambdaLogGroupKmsKey: !Ref pLambdaLogGroupKmsKey
        pLambdaLogGroupRetention: !Ref pLambdaLogGroupRetention
        pLambdaLogLevel: !Ref pLambdaLogLevel
        pRegionLinkingMode: !Ref pRegionLinkingMode
        pSourceStackName:
          !If [
            cDeployConfigManagementSolution,
            !Ref rConfigManagementSolutionStack,
            "",
          ]
        pSRAAlarmEmail: !Ref pSRAAlarmEmail
        pEnableNISTStandard: !Ref pEnableNISTStandard
        pNISTStandardVersion: !Ref pNISTStandardVersion

  rInspectorSolutionStack:
    Type: AWS::CloudFormation::Stack
    DependsOn: rCommonPrerequisitesMainSsm
    Condition: cDeployInspectorSolution
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      TemplateURL: !Sub https://${pSRAStagingS3BucketNamePrefix}-${AWS::AccountId}-${AWS::Region}.s3.${AWS::Region}.${AWS::URLSuffix}/sra-inspector-org/templates/sra-inspector-org-main-ssm.yaml
      Parameters:
        pScanComponents: !Join
          - ","
          - !Ref pScanComponents
        pEcrRescanDuration: !Ref pEcrRescanDuration
        pLambdaLogGroupKmsKey: !Ref pLambdaLogGroupKmsKey
        pLambdaLogGroupRetention: !Ref pLambdaLogGroupRetention
        pLambdaLogLevel: !Ref pLambdaLogLevel
        pSRAAlarmEmail: !Ref pSRAAlarmEmail
        pComplianceFrequency: !Ref pComplianceFrequency

  rConfigSolutionStack:
    Type: AWS::CloudFormation::Stack
    DependsOn: rCommonPrerequisitesMainSsm
    Condition: cDeployConfigSolution
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      TemplateURL: !Sub https://${pSRAStagingS3BucketNamePrefix}-${AWS::AccountId}-${AWS::Region}.s3.${AWS::Region}.${AWS::URLSuffix}/sra-config-org/templates/sra-config-org-main-ssm.yaml
      Parameters:
        pControlTowerRegionsOnly: !Ref pCommonPrerequisitesRegionsOnly
        pEnabledRegions: !Ref pConfigEnabledRegions
        pRecorderName: !Ref pRecorderName
        pDeliveryChannelName: !Ref pDeliveryChannelName
        pConfigOrgDeliveryBucketPrefix: !Ref pConfigOrgDeliveryBucketPrefix
        pConfigOrgDeliveryKeyAlias: !Ref pConfigOrgDeliveryKeyAlias
        pConfigTopicName: !Ref pConfigTopicName
        pSubscribeToConfigurationTopic: !Ref pSubscribeToConfigurationTopic
        pConfigurationEmail: !Ref pConfigurationEmail
        pConfigOrgSnsKeyAlias: !Ref pConfigOrgSnsKeyAlias
        pAggregatorName: !Ref pAggregatorName
        pAggregatorRoleName: !Ref pAggregatorRoleName
        pRegisterDelegatedAdminAccount: !Ref pRegisterDelegatedAdminAccount
        pLambdaLogGroupKmsKey: !Ref pLambdaLogGroupKmsKey
        pLambdaLogLevel: !Ref pLambdaLogLevel
        pSRAAlarmEmail: !Ref pSRAAlarmEmail
        pLambdaLogGroupRetention: !Ref pLambdaLogGroupRetention
        pFrequency: !Ref pFrequency
        pAllSupported: !Ref pAllSupported
        pIncludeGlobalResourceTypes: !Ref pIncludeGlobalResourceTypes
        pResourceTypes: !Ref pResourceTypes

  rShieldSolutionStack:
    Type: AWS::CloudFormation::Stack
    DependsOn: rCommonPrerequisitesMainSsm
    Condition: cDeployShieldSolution
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      TemplateURL: !Sub https://${pSRAStagingS3BucketNamePrefix}-${AWS::AccountId}-${AWS::Region}.s3.${AWS::Region}.${AWS::URLSuffix}/sra-shield-advanced/templates/sra-shield-advanced-main-ssm.yaml
      Parameters:
        pShieldWarning: !Ref pShieldWarning
        pComplianceFrequency: !Ref pComplianceFrequency
        pCreateLambdaLogGroup: !If [cCreateLambdaLogGroup, true, false]
        pLambdaLogGroupRetention: !Ref pLambdaLogGroupRetention
        pLambdaLogLevel: !Ref pLambdaLogLevel
        pSRAAlarmEmail: !Ref pSRAAlarmEmail
        pLambdaLogGroupKmsKey: !Ref pLambdaLogGroupKmsKey
        pConfigureDRTTeamAccess: !Ref pConfigureDRTTeamAccess
        pResourcesToProtect: !Join
          - ","
          - !Ref pResourcesToProtect
        pShieldAccountsToProtect: !Join
          - ","
          - !Ref pShieldAccountsToProtect
        pShieldDRTRoleName: !Ref pShieldDRTRoleName
        pShieldAutoRenew: !Ref pShieldAutoRenew
        pShieldDRTLogBuckets: !Join
          - ","
          - !Ref pShieldDRTLogBuckets
        pProtectionGroup0AccountId: !Ref pProtectionGroup0AccountId
        pProtectionGroup0Id: !Ref pProtectionGroup0Id
        pProtectionGroup0Aggregation: !Ref pProtectionGroup0Aggregation
        pProtectionGroup0Pattern: !Ref pProtectionGroup0Pattern
        pProtectionGroup0ResourceType: !Ref pProtectionGroup0ResourceType
        pProtectionGroup0Members: !Join
          - ","
          - !Ref pProtectionGroup0Members
        pProtectionGroup1AccountId: !Ref pProtectionGroup1AccountId
        pProtectionGroup1Id: !Ref pProtectionGroup1Id
        pProtectionGroup1Aggregation: !Ref pProtectionGroup1Aggregation
        pProtectionGroup1Pattern: !Ref pProtectionGroup1Pattern
        pProtectionGroup1ResourceType: !Ref pProtectionGroup1ResourceType
        pProtectionGroup1Members: !Join
          - ","
          - !Ref pProtectionGroup1Members
        pProtectionGroup2AccountId: !Ref pProtectionGroup2AccountId
        pProtectionGroup2Id: !Ref pProtectionGroup2Id
        pProtectionGroup2Aggregation: !Ref pProtectionGroup2Aggregation
        pProtectionGroup2Pattern: !Ref pProtectionGroup2Pattern
        pProtectionGroup2ResourceType: !Ref pProtectionGroup2ResourceType
        pProtectionGroup2Members: !Join
          - ","
          - !Ref pProtectionGroup2Members
        pProtectionGroup3AccountId: !Ref pProtectionGroup3AccountId
        pProtectionGroup3Id: !Ref pProtectionGroup3Id
        pProtectionGroup3Aggregation: !Ref pProtectionGroup3Aggregation
        pProtectionGroup3Pattern: !Ref pProtectionGroup3Pattern
        pProtectionGroup3ResourceType: !Ref pProtectionGroup3ResourceType
        pProtectionGroup3Members: !Join
          - ","
          - !Ref pProtectionGroup3Members
        pProtectionGroup4AccountId: !Ref pProtectionGroup4AccountId
        pProtectionGroup4Id: !Ref pProtectionGroup4Id
        pProtectionGroup4Aggregation: !Ref pProtectionGroup4Aggregation
        pProtectionGroup4Pattern: !Ref pProtectionGroup4Pattern
        pProtectionGroup4ResourceType: !Ref pProtectionGroup4ResourceType
        pProtectionGroup4Members: !Join
          - ","
          - !Ref pProtectionGroup4Members
        pShieldEnableProactiveEngagement: !Ref pShieldEnableProactiveEngagement
        pShieldProactiveEngagementEmail: !Ref pShieldProactiveEngagementEmail
        pShieldProactiveEngagementPhoneNumber: !Ref pShieldProactiveEngagementPhoneNumber
        pShieldProactiveEngagementNotes: !Ref pShieldProactiveEngagementNotes

  rPatchMgrSolutionStack:
    Type: AWS::CloudFormation::Stack
    DependsOn: rCommonPrerequisitesMainSsm
    Condition: cDeployPatchMgrSolution
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      TemplateURL: !Sub https://${pSRAStagingS3BucketNamePrefix}-${AWS::AccountId}-${AWS::Region}.s3.${AWS::Region}.${AWS::URLSuffix}/sra-patch-mgmt-org/templates/sra-patch_mgmt-org-main-ssm.yaml
      Parameters:
        pPatchMgmtRoleName: !Ref pPatchMgmtRoleName
        # Window 1
        pPatchMgmtMaintWindow1Name: !Ref pPatchMgmtMaintWindow1Name
        pPatchMgmtMaintWindow1Desc: !Ref pPatchMgmtMaintWindow1Desc
        pPatchMgmtMaintWindow1Schedule: !Ref pPatchMgmtMaintWindow1Schedule
        pPatchMgmtMaintWindow1Duration: !Ref pPatchMgmtMaintWindow1Duration
        pPatchMgmtMaintWindow1Cutoff: !Ref pPatchMgmtMaintWindow1Cutoff
        pPatchMgmtMaintWindow1TZ: !Ref pPatchMgmtMaintWindow1TZ
        pPatchMgmtTask1Name: !Ref pPatchMgmtTask1Name
        pPatchMgmtTask1Desc: !Ref pPatchMgmtTask1Desc
        pPatchMgmtTask1Operation: !Ref pPatchMgmtTask1Operation
        pPatchMgmtTask1RebootOption: !Ref pPatchMgmtTask1RebootOption
        pPatchMgmtTask1RunCmd: !Ref pPatchMgmtTask1RunCmd
        pPatchMgmtTarget1Name: !Ref pPatchMgmtTarget1Name
        pPatchMgmtTarget1Desc: !Ref pPatchMgmtTarget1Desc
        pPatchMgmtTarget1Value1: !Ref pPatchMgmtTarget1Value1
        pPatchMgmtTarget1Value2: !Ref pPatchMgmtTarget1Value2
        # Window 2
        pPatchMgmtMaintWindow2Name: !Ref pPatchMgmtMaintWindow2Name
        pPatchMgmtMaintWindow2Desc: !Ref pPatchMgmtMaintWindow2Desc
        pPatchMgmtMaintWindow2Schedule: !Ref pPatchMgmtMaintWindow2Schedule
        pPatchMgmtMaintWindow2Duration: !Ref pPatchMgmtMaintWindow2Duration
        pPatchMgmtMaintWindow2Cutoff: !Ref pPatchMgmtMaintWindow2Cutoff
        pPatchMgmtMaintWindow2TZ: !Ref pPatchMgmtMaintWindow2TZ
        pPatchMgmtTask2Name: !Ref pPatchMgmtTask2Name
        pPatchMgmtTask2Desc: !Ref pPatchMgmtTask2Desc
        pPatchMgmtTask2Operation: !Ref pPatchMgmtTask2Operation
        pPatchMgmtTask2RebootOption: !Ref pPatchMgmtTask2RebootOption
        pPatchMgmtTask2RunCmd: !Ref pPatchMgmtTask2RunCmd
        pPatchMgmtTarget2Name: !Ref pPatchMgmtTarget2Name
        pPatchMgmtTarget2Desc: !Ref pPatchMgmtTarget2Desc
        pPatchMgmtTarget2Value1: !Ref pPatchMgmtTarget2Value1
        # Window 3
        pPatchMgmtMaintWindow3Name: !Ref pPatchMgmtMaintWindow3Name
        pPatchMgmtMaintWindow3Desc: !Ref pPatchMgmtMaintWindow3Desc
        pPatchMgmtMaintWindow3Schedule: !Ref pPatchMgmtMaintWindow3Schedule
        pPatchMgmtMaintWindow3Duration: !Ref pPatchMgmtMaintWindow3Duration
        pPatchMgmtMaintWindow3Cutoff: !Ref pPatchMgmtMaintWindow3Cutoff
        pPatchMgmtMaintWindow3TZ: !Ref pPatchMgmtMaintWindow3TZ
        pPatchMgmtTask3Name: !Ref pPatchMgmtTask3Name
        pPatchMgmtTask3Desc: !Ref pPatchMgmtTask3Desc
        pPatchMgmtTask3Operation: !Ref pPatchMgmtTask3Operation
        pPatchMgmtTask3RebootOption: !Ref pPatchMgmtTask3RebootOption
        pPatchMgmtTask3RunCmd: !Ref pPatchMgmtTask3RunCmd
        pPatchMgmtTarget3Name: !Ref pPatchMgmtTarget3Name
        pPatchMgmtTarget3Desc: !Ref pPatchMgmtTarget3Desc
        pPatchMgmtTarget3Value1: !Ref pPatchMgmtTarget3Value1
